<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DigitalMarket</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { padding: 20px; background: #f5f7fa; }
        
        /* Estilos para el menú de navegación */
        .header-nav {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 0 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-weight: bold;
            font-size: 1.8rem;
            padding: 15px 0;
            display: flex;
            align-items: center;
        }
        
        .logo i {
            margin-right: 10px;
        }
        
        .nav-menu {
            display: flex;
            list-style: none;
        }
        
        .nav-menu li {
            position: relative;
        }
        
        .nav-menu a {
            color: white;
            text-decoration: none;
            padding: 15px 20px;
            display: block;
            transition: background 0.3s;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        
        .nav-menu a i {
            margin-right: 8px;
        }
        
        .nav-menu a:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            margin-left: 10px;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .hamburger {
            display: none;
            cursor: pointer;
            font-size: 1.5rem;
            padding: 10px;
        }
        
        /* Nuevo estilo para el botón de vendedor en web */
        .seller-btn {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            margin-left: 10px;
        }
        
        .seller-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* CORRECCIÓN: Ocultar información de usuario en móvil */
        .mobile-user-info {
            display: none !important; /* Ocultar completamente en móvil */
        }
        
        /* CORRECCIÓN: Botón de publicar producto más pequeño y en esquina derecha */
        .publish-btn-container {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }
        
        .publish-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            width: auto;
            display: inline-block;
        }
        
        .publish-btn:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        
        /* Responsive */
        @media screen and (max-width: 768px) {
            .hamburger {
                display: block;
            }
            
            .nav-menu {
                position: fixed;
                left: -100%;
                top: 0;
                flex-direction: column;
                background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
                width: 80%;
                height: 100vh;
                z-index: 999;
                transition: left 0.3s;
                padding-top: 20px;
                box-shadow: 2px 0 15px rgba(0,0,0,0.2);
                overflow-y: auto;
            }
            
            .nav-menu.active {
                left: 0;
            }
            
            .nav-menu li {
                width: 100%;
            }
            
            .nav-menu a {
                padding: 15px 20px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .close-btn {
                position: absolute;
                top: 15px;
                right: 20px;
                font-size: 1.5rem;
                cursor: pointer;
                display: block !important;
            }
            
            .logout-btn, .seller-btn {
                margin: 10px 20px;
                text-align: center;
                background: rgba(255, 255, 255, 0.2);
                border-radius: 5px;
            }
            
            /* CORRECCIÓN: Ocultar información de usuario en móvil */
            .mobile-user-info {
                display: none !important;
            }
            
            /* Ocultar la sección de información de usuario en el cuerpo en móvil */
            #userInfo {
                display: none !important;
            }
            
            /* Ocultar el botón de vendedor en web en móvil */
            #sellerNavItem {
                display: none !important;
            }
            
            /* CORRECCIÓN: Botón de publicar en móvil ocupa todo el ancho */
            .publish-btn-container {
                justify-content: center;
            }
            
            .publish-btn {
                width: 100%;
                text-align: center;
            }
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            display: flex;
            gap: 20px;
        }
        
        .main-content {
            flex: 1;
        }
        
        .categories-sidebar {
            width: 250px;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            height: fit-content;
        }
        
        .categories-sidebar h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            padding-bottom: 10px;
            border-bottom: 2px solid #6a11cb;
        }
        
        .category-item {
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }
        
        .category-item:hover {
            background: #f0f8ff;
        }
        
        .category-item.active {
            background: #6a11cb;
            color: white;
        }
        
        .category-count {
            background: #e9ecef;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }
        
        .category-item.active .category-count {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .mobile-categories-toggle {
            display: none;
            background: #6a11cb;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            width: 100%;
            cursor: pointer;
            font-weight: 600;
        }
        
        .mobile-categories {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        @media screen and (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .categories-sidebar {
                display: none;
            }
            
            .mobile-categories-toggle {
                display: block;
            }
            
            .mobile-categories.active {
                display: block;
            }
        }
        
        h1, h2 { margin-bottom: 15px; color: #2c3e50; }
        .form-group { margin-bottom: 20px; }
        input, textarea, select, button { width: 100%; padding: 12px 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #6a11cb; box-shadow: 0 0 0 2px rgba(106, 17, 203, 0.2); }
        button { background: #6a11cb; color: white; border: none; cursor: pointer; transition: all 0.3s; font-weight: 600; }
        button:hover { background: #2575fc; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        .message { padding: 12px; margin: 10px 0; border-radius: 8px; }
        .error { background: #ffebee; color: #d32f2f; border-left: 4px solid #d32f2f; }
        .success { background: #e8f5e9; color: #388e3c; border-left: 4px solid #388e3c; }
        .product { background: white; padding: 20px; margin: 10px 0; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .seller-verification { background: #f0f8ff; padding: 20px; margin: 20px 0; border-radius: 10px; border-left: 4px solid #6a11cb; }
        .verification-status { padding: 12px; margin: 10px 0; border-radius: 8px; text-align: center; font-weight: 600; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-approved { background: #d4edda; color: #155724; }
        .status-rejected { background: #f8d7da; color: #721c24; }
        
        /* Estilos para formularios de autenticación */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 70vh;
        }
        
        .auth-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 450px;
            overflow: hidden;
        }
        
        .auth-header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .auth-header h2 {
            margin: 0;
            color: white;
        }
        
        .auth-body {
            padding: 25px;
        }
        
        .auth-footer {
            padding: 15px 25px 25px;
            text-align: center;
            border-top: 1px solid #eee;
        }
        
        .auth-toggle {
            background: none;
            border: none;
            color: #6a11cb;
            cursor: pointer;
            font-weight: 600;
            width: auto;
            padding: 0;
            margin: 0;
        }
        
        .auth-toggle:hover {
            text-decoration: underline;
            transform: none;
            box-shadow: none;
            background: none;
        }
        
        /* Estilos para el panel de administración */
        .admin-panel { 
            background: #fff; 
            padding: 25px; 
            margin: 20px 0; 
            border-radius: 10px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border-left: 5px solid #6a11cb;
        }
        .admin-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        .verification-item { 
            border: 1px solid #ddd; 
            padding: 20px; 
            margin: 15px 0; 
            border-radius: 8px; 
            background: #f9f9f9;
        }
        .verification-images { 
            display: flex; 
            gap: 15px; 
            margin: 15px 0; 
            flex-wrap: wrap;
        }
        .verification-images img { 
            max-width: 250px; 
            max-height: 250px;
            border: 1px solid #ddd; 
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .admin-actions { 
            display: flex; 
            gap: 10px; 
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #ddd;
        }
        .admin-btn { 
            padding: 10px 15px;
            flex: 1;
        }
        .approve-btn { 
            background: #28a745; 
        }
        .approve-btn:hover {
            background: #218838;
        }
        .reject-btn { 
            background: #dc3545; 
        }
        .reject-btn:hover {
            background: #c82333;
        }
        .file-input { padding: 5px; }
        .preview-container { margin: 10px 0; }
        .preview-image { 
            max-width: 200px; 
            max-height: 200px; 
            margin: 5px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
        }
        
        .admin-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification-success {
            background: #28a745;
        }
        
        .notification-error {
            background: #dc3545;
        }
        
        .admin-section-title {
            color: #6a11cb;
            margin: 25px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #6a11cb;
        }
        
        .image-warning {
            color: #856404;
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 14px;
        }
        
        /* Estilos para el carrito */
        .cart-section {
            background: white;
            padding: 25px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .cart-total {
            font-weight: bold;
            font-size: 18px;
            margin: 15px 0;
            text-align: right;
        }
        
        .buy-btn, .cart-btn {
            padding: 10px 15px;
            margin: 5px;
            width: auto;
        }
        
        .buy-btn {
            background: #28a745;
        }
        
        .cart-btn {
            background: #ffc107;
            color: black;
        }
        
        .product-actions {
            display: flex;
            margin-top: 10px;
        }
        
        /* Estilos para compras y notificaciones */
        .purchase-item {
            background: #f8f9fa;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #6a11cb;
        }
        
        .purchase-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            display: inline-block;
            margin: 5px 0;
            font-weight: 600;
        }
        
        .instructions-box {
            background: #e9ecef;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .wallet-address {
            font-family: monospace;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            word-break: break-all;
            margin: 15px 0;
            border: 1px dashed #6a11cb;
        }
        
        /* Estilos para credenciales */
        .credentials-box {
            background: #d4edda;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #28a745;
        }
        
        .credentials-waiting {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        
        .delivery-form {
            background: #e9ecef;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .seller-sales {
            background: white;
            padding: 25px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        /* Secciones ocultas por defecto */
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        /* NUEVOS ESTILOS PARA EL GRID DE PRODUCTOS */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        
        .product-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: transform 0.3s, box-shadow 0.3s;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease, transform 0.6s ease;
        }
        
        .product-card.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        
        .product-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
        }
        
        .product-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .product-price {
            color: #6a11cb;
            font-weight: bold;
            font-size: 20px;
            margin-bottom: 15px;
        }
        
        .product-description {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .product-category {
            display: inline-block;
            background: #f0f8ff;
            color: #6a11cb;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .product-seller {
            font-size: 12px;
            color: #888;
            margin-bottom: 15px;
        }
        
        .product-actions-grid {
            display: flex;
            gap: 10px;
        }
        
        .buy-btn-grid, .cart-btn-grid {
            flex: 1;
            padding: 10px;
            font-size: 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .buy-btn-grid {
            background: #28a745;
            color: white;
        }
        
        .buy-btn-grid:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .cart-btn-grid {
            background: #ffc107;
            color: black;
        }
        
        .cart-btn-grid:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        /* Responsive */
        @media screen and (max-width: 768px) {
            .products-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .auth-card {
                margin: 0 10px;
            }
            
            /* Ocultar la sección de información de usuario en el cuerpo en móvil */
            #userInfo {
                display: none !important;
            }
        }

        /* Estilos para la sección de usuario */
        .user-info-section {
            background: white;
            padding: 25px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            display: none; /* Ocultar por defecto */
        }
        
        .user-info-section.active {
            display: block; /* Mostrar cuando tenga la clase active */
        }
        
        /* Estilos para la sección de verificación en móvil */
        .mobile-verification-section {
            display: none;
            padding: 15px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.05);
        }
        
        .mobile-verification-status {
            padding: 8px;
            margin: 10px 0;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
        }
        
        .mobile-verification-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 5px;
            width: 100%;
            text-align: center;
            margin: 10px 0;
            cursor: pointer;
        }
        
        @media screen and (max-width: 768px) {
            .mobile-verification-section {
                display: block;
            }
            
            /* Ocultar la sección de verificación en el cuerpo en móvil */
            #sellerVerificationSection {
                display: none !important;
            }
            
            /* CORRECCIÓN: Mostrar la sección de Mi Cuenta en móvil */
            #userInfo {
                display: block !important;
            }
            
            /* CORRECCIÓN: Mostrar el formulario de vendedor en móvil */
            #verificationForm {
                display: block !important;
            }
        }

        /* CORRECCIÓN: Estilos específicos para el formulario en móvil */
        .mobile-form-container {
            display: none;
        }
        
        @media screen and (max-width: 768px) {
            .mobile-form-container {
                display: block;
                padding: 15px;
                background: #f0f8ff;
                margin: 15px 0;
                border-radius: 10px;
            }
            
            .desktop-only {
                display: none !important;
            }
        }

        /* Estilos para el mensaje de confirmación en móvil */
        .verification-confirmation {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            border-left: 4px solid #4caf50;
            display: none;
        }
        
        .verification-confirmation h3 {
            color: #2e7d32;
            margin-bottom: 10px;
        }
        
        .verification-confirmation p {
            color: #388e3c;
            margin-bottom: 10px;
        }
        
        /* NUEVOS ESTILOS PARA LA GARANTÍA */
        .warranty-info {
            background: #f0f8ff;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 14px;
            border-left: 3px solid #6a11cb;
        }
        
        .warranty-badge {
            display: inline-block;
            background: #e8f5e9;
            color: #2e7d32;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 5px;
        }
        
        /* Estilos para el formulario de entrega mejorado */
        .delivery-form-enhanced {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #e9ecef;
        }
        
        .delivery-form-enhanced h4 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .delivery-details {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            margin-bottom: 15px;
        }
        
        /* CORRECCIÓN: Estilos para mostrar el ID de Binance del vendedor */
        .seller-binance-id {
            background: #e7f3ff;
            padding: 10px 15px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 3px solid #2575fc;
            font-family: monospace;
            font-weight: bold;
        }
        
        /* CORRECCIÓN: Estilos para mostrar los cargos adicionales */
        .additional-fees {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
        }
        
        .fee-breakdown {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        
        .fee-total {
            font-weight: bold;
            border-top: 1px solid #ddd;
            padding-top: 10px;
            margin-top: 10px;
        }
        
        /* Estilos para el historial de transacciones */
        .transaction-history {
            background: white;
            padding: 25px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        .transaction-item {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            background: #f8f9fa;
        }
        
        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .transaction-id {
            font-family: monospace;
            font-weight: bold;
            color: #6a11cb;
        }
        
        .transaction-date {
            color: #6c757d;
            font-size: 14px;
        }
        
        .transaction-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .transaction-buyer, .transaction-seller {
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }
        
        .transaction-buyer h4, .transaction-seller h4 {
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        @media screen and (max-width: 768px) {
            .transaction-details {
                grid-template-columns: 1fr;
            }
        }
        
        /* NUEVOS ESTILOS PARA EL CHAT DE SOPORTE */
        .chat-support {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-title {
            font-weight: bold;
            font-size: 16px;
        }
        
        .chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .message-sent {
            align-self: flex-end;
            background: #6a11cb;
            color: white;
        }
        
        .message-received {
            align-self: flex-start;
            background: #f0f0f0;
            color: #333;
        }
        
        .chat-input-container {
            display: flex;
            padding: 10px;
            border-top: 1px solid #eee;
        }
        
        .chat-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }
        
        .chat-send {
            background: #6a11cb;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-left: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chat-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 999;
        }
        
        .chat-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @media screen and (max-width: 768px) {
            .chat-support {
                width: 100%;
                height: 100%;
                bottom: 0;
                right: 0;
                border-radius: 0;
            }
            
            .chat-toggle {
                bottom: 80px;
                right: 20px;
            }
        }
        
        /* Estilos para la barra de búsqueda */
        .search-container {
            margin-bottom: 20px;
            position: relative;
        }
        
        .search-input {
            padding: 12px 45px 12px 15px;
            border: 1px solid #ddd;
            border-radius: 30px;
            font-size: 16px;
            width: 100%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .search-button {
            position: absolute;
            right: 5px;
            top: 5px;
            background: #6a11cb;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Estilos para el contador del carrito */
        .cart-count {
            background: #ff4757;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 5px;
            right: 5px;
        }
        
        /* Estilos para el sistema de notificaciones */
        .notifications-panel {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 350px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            flex-direction: column;
            max-height: 500px;
            overflow: hidden;
        }
        
        .notifications-header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .notifications-title {
            font-weight: bold;
            font-size: 16px;
        }
        
        .notifications-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
        
        .notifications-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .notification-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .notification-item:hover {
            background: #f5f5f5;
        }
        
        .notification-item.unread {
            background: #f0f8ff;
        }
        
        .notification-time {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        
        .notifications-toggle {
            position: relative;
            cursor: pointer;
        }
        
        .notifications-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @media screen and (max-width: 768px) {
            .notifications-panel {
                width: 90%;
                right: 5%;
                top: 60px;
            }
        }
        
        /* Estilos para el botón de adjuntar comprobante */
        .proof-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .proof-btn:hover {
            background: #138496;
        }
        
        .proof-image {
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        /* NUEVOS ESTILOS PARA EL CHAT CON VENDEDORES */
        .admin-sellers-chat {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #e9ecef;
        }
        
        .sellers-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }
        
        .seller-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .seller-item:hover {
            background: #f0f8ff;
        }
        
        .seller-item.active {
            background: #6a11cb;
            color: white;
        }
        
        .seller-chat-messages {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .seller-chat-input {
            display: flex;
            gap: 10px;
        }
        
        .seller-chat-input input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .seller-chat-input button {
            padding: 8px 15px;
            width: auto;
        }
    </style>
</head>
<body>
    <!-- Menú de navegación -->
    <nav class="header-nav">
        <div class="nav-container">
            <div class="logo"><i class="fas fa-store"></i>DigitalMarket</div>
            <div class="hamburger">☰</div>
            <ul class="nav-menu">
                <!-- CORRECCIÓN: Información de usuario en móvil OCULTADA -->
                <li class="mobile-user-info" style="display: none !important;">
                    <h3>Mi Cuenta</h3>
                    <p><strong>Nombre:</strong> <span id="mobileUserName">Usuario</span></p>
                    <p><strong>Email:</strong> <span id="mobileUserEmail"></span></p>
                    <p><strong>Rol:</strong> <span id="mobileUserRole" class="user-role">Comprador</span></p>
                </li>
                
                <!-- Sección de verificación en móvil -->
                <li class="mobile-verification-section">
                    <h4>Verificación de Vendedor</h4>
                    <div id="mobileSellerStatus" class="mobile-verification-status"></div>
                    <button id="mobileShowVerificationForm" class="mobile-verification-btn">Convertirme en vendedor</button>
                </li>
                
                <li><a class="nav-link" data-section="productsSection"><i class="fas fa-box"></i> Productos</a></li>
                <li id="adminNavItem" style="display:none;"><a class="nav-link" data-section="adminPanel"><i class="fas fa-cog"></i> Panel Admin</a></li>
                <li id="salesNavItem" style="display:none;"><a class="nav-link" data-section="sellerSales"><i class="fas fa-chart-line"></i> Mis Ventas</a></li>
                <li id="purchasesNavItem" style="display:none;"><a class="nav-link" data-section="myPurchases"><i class="fas fa-shopping-bag"></i> Mis Compras</a></li>
                <li id="cartNavItem" style="display:none;">
                    <a class="nav-link" data-section="cartSection">
                        <i class="fas fa-shopping-cart"></i> Carrito
                        <span id="navCartCount" class="cart-count" style="display:none;">0</span>
                    </a>
                </li>
                
                <!-- Nuevo elemento para Convertirse en Vendedor en web -->
                <li id="sellerNavItem" style="display:none;"><a class="seller-btn" id="showVerificationFormWeb"><i class="fas fa-store"></i> Convertirme en Vendedor</a></li>
                
                <!-- Nuevo elemento para mostrar información de usuario en web -->
                <li id="userInfoNavItem" style="display:none;"><a class="nav-link" id="showUserInfo"><i class="fas fa-user"></i> Mi Cuenta</a></li>
                
                <!-- Nuevo elemento para notificaciones -->
                <li id="notificationsNavItem" style="display:none;" class="notifications-toggle">
                    <a class="nav-link" id="showNotifications">
                        <i class="fas fa-bell"></i> Notificaciones
                        <span id="navNotificationsCount" class="notifications-badge" style="display:none;">0</span>
                    </a>
                </li>
                
                <!-- Nuevo elemento para soporte en móvil -->
                <li id="supportNavItem" style="display:none;"><a class="nav-link" id="showSupportMobile"><i class="fas fa-headset"></i> Soporte</a></li>
                
                <li id="logoutNavItem" style="display:none;"><a class="logout-btn" id="navLogoutBtn"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a></li>
                <span class="close-btn" style="display:none;">×</span>
            </ul>
        </div>
    </nav>

    <div class="container">
        <!-- Sidebar de categorías (solo visible en desktop) -->
        <div class="categories-sidebar">
            <h3>Categorías</h3>
            <div id="categoriesList"></div>
        </div>
        
        <!-- Contenido principal -->
        <div class="main-content">
            <!-- Botón para mostrar categorías en móvil -->
            <button class="mobile-categories-toggle" id="mobileCategoriesToggle">
                <i class="fas fa-list"></i> Ver Categorías
            </button>
            
            <!-- Categorías en móvil -->
            <div class="mobile-categories" id="mobileCategories">
                <h3>Categorías</h3>
                <div id="mobileCategoriesList"></div>
            </div>
            
            <!-- Barra de búsqueda -->
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="Buscar productos...">
                <button class="search-button" id="searchButton">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            
            <!-- CORRECCIÓN: Contenedor del formulario para móvil -->
            <div class="mobile-form-container" id="mobileVerificationContainer" style="display:none;">
                <h3>Convertirme en Vendedor</h3>
                
                <!-- Mensaje de confirmación después de enviar el formulario -->
                <div id="mobileVerificationConfirmation" class="verification-confirmation">
                    <h3><i class="fas fa-check-circle"></i> Solicitud Enviada</h3>
                    <p><strong>¡Esperando verificación!</strong></p>
                    <p>Pronto un administrador aprobará o denegará tu solicitud.</p>
                    <p>Recibirás una notificación cuando tu estado cambie.</p>
                    <button id="mobileBackToMenu" class="mobile-verification-btn">Volver al Menú</button>
                </div>
                
                <form id="mobileVerificationForm" onsubmit="return false;">
                    <div class="form-group">
                        <input type="text" id="mobileFullName" placeholder="Nombre completo" required>
                    </div>
                    <div class="form-group">
                        <input type="text" id="mobileCountry" placeholder="País" required>
                    </div>
                    <div class="form-group">
                        <input type="text" id="mobileIdNumber" placeholder="Número de identificación" required>
                    </div>
                    <div class="form-group">
                        <input type="text" id="mobileBinanceId" placeholder="ID de Binance" required>
                    </div>
                    <div class="form-group">
                        <input type="text" id="mobileBusinessName" placeholder="Nombre de tu negocio o marca">
                    </div>
                    <div class="form-group">
                        <textarea id="mobileBusinessDescription" placeholder="Describe los productos o servicios que ofreces"></textarea>
                    </div>
                    <div class="form-group">
                        <input type="tel" id="mobilePhoneNumber" placeholder="Número de teléfono de contacto" required>
                    </div>
                    
                    <div class="image-warning">
                        <strong>Importante:</strong> Para verificar tu identidad, necesitamos dos fotografías:
                        <ol>
                            <li>Foto de tu documento de identidad (con los dígitos sensibles, códigos de barras y QR tapados, solo mostrando tu rostro)</li>
                            <li>Selfie tuyo sosteniendo el documento (mostrando claramente tu rostro)</li>
                        </ol>
                        Asegúrate de que las imágenes sean claras y legibles. Tapa toda información sensible como números de identificación, códigos de barras y códigos QR.
                    </div>
                    
                    <div class="form-group">
                        <label>Foto de documento (solo rostro visible, información sensible tapada):</label>
                        <input type="file" id="mobileIdPhoto" accept="image/*" class="file-input" required>
                        <div class="preview-container">
                            <img id="mobileIdPhotoPreview" class="preview-image" style="display:none;">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Selfie con documento (mostrando rostro):</label>
                        <input type="file" id="mobileSelfiePhoto" accept="image/*" class="file-input" required>
                        <div class="preview-container">
                            <img id="mobileSelfiePhotoPreview" class="preview-image" style="display:none;">
                        </div>
                    </div>
                    
                    <button id="mobileSubmitVerificationBtn">Enviar Solicitud de Verificación</button>
                    <div id="mobileVerificationMessage" class="message"></div>
                </form>
            </div>
            
            <!-- Sección de Autenticación -->
            <div id="authSection" class="section active">
                <div class="auth-container">
                    <div class="auth-card">
                        <div class="auth-header">
                            <h2 id="authTitle">Iniciar Sesión</h2>
                        </div>
                        <div class="auth-body">
                            <div id="loginForm">
                                <div class="form-group">
                                    <input type="email" id="loginEmail" placeholder="Correo electrónico">
                                </div>
                                <div class="form-group">
                                    <input type="password" id="loginPassword" placeholder="Contraseña">
                                </div>
                                <button id="loginBtn">Iniciar Sesión</button>
                                <div id="loginMessage" class="message"></div>
                            </div>
                            
                            <div id="registerForm" style="display:none;">
                                <div class="form-group">
                                    <input type="text" id="registerName" placeholder="Nombre completo">
                                </div>
                                <div class="form-group">
                                    <input type="email" id="registerEmail" placeholder="Correo electrónico">
                                </div>
                                <div class="form-group">
                                    <input type="password" id="registerPassword" placeholder="Contraseña">
                                </div>
                                <div class="form-group">
                                    <input type="password" id="registerConfirmPassword" placeholder="Confirmar contraseña">
                                </div>
                                <button id="registerBtn">Registrarse</button>
                                <div id="registerMessage" class="message"></div>
                            </div>
                        </div>
                        <div class="auth-footer">
                            <p id="authToggleText">¿No tienes cuenta? <button class="auth-toggle" id="authToggleBtn">Regístrate aquí</button></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Información del usuario (solo visible en desktop al hacer clic) -->
            <div id="userInfo" class="user-info-section">
                <h2>Información de Usuario</h2>
                <div class="form-group">
                    <p><strong>Nombre:</strong> <span id="userName">Usuario</span></p>
                    <p><strong>Email:</strong> <span id="userEmail"></span></p>
                    <p><strong>Rol:</strong> <span id="userRole">Comprador</span></p>
                </div>
                <button id="logoutBtn">Cerrar Sesión</button>
                
                <!-- Sección de Verificación de Vendedor (solo visible en desktop) -->
                <div id="sellerVerificationSection" class="seller-verification">
                    <h3>Verificación de Vendedor</h3>
                    <div id="sellerStatus" class="verification-status"></div>
                    <button id="showVerificationForm">Convertirme en vendedor</button>
                    
                    <form id="verificationForm" style="display:none;" onsubmit="return false;">
                        <h4>Solicitud de Verificación</h4>
                        <div class="form-group">
                            <input type="text" id="fullName" placeholder="Nombre completo" required>
                        </div>
                        <div class="form-group">
                            <input type="text" id="country" placeholder="País" required>
                        </div>
                        <div class="form-group">
                            <input type="text" id="idNumber" placeholder="Número de identificación" required>
                        </div>
                        <div class="form-group">
                            <input type="text" id="binanceId" placeholder="ID de Binance" required>
                        </div>
                        <div class="form-group">
                            <input type="text" id="businessName" placeholder="Nombre de tu negocio o marca">
                        </div>
                        <div class="form-group">
                            <textarea id="businessDescription" placeholder="Describe los productos o servicios que ofreces"></textarea>
                        </div>
                        <div class="form-group">
                            <input type="tel" id="phoneNumber" placeholder="Número de teléfono de contacto" required>
                        </div>
                        
                        <div class="image-warning">
                            <strong>Importante:</strong> Para verificar tu identidad, necesitamos dos fotografías:
                            <ol>
                                <li>Foto de tu documento de identidad (con los dígitos sensibles, códigos de barras y QR tapados, solo mostrando tu rostro)</li>
                                <li>Selfie tuyo sosteniendo el documento (mostrando claramente tu rostro)</li>
                            </ol>
                            Asegúrate de que las imágenes sean claras y legibles. Tapa toda información sensible como números de identificación, códigos de barras y códigos QR.
                        </div>
                        
                        <div class="form-group">
                            <label>Foto de documento (solo rostro visible, información sensible tapada):</label>
                            <input type="file" id="idPhoto" accept="image/*" class="file-input" required>
                            <div class="preview-container">
                                <img id="idPhotoPreview" class="preview-image" style="display:none;">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Selfie con documento (mostrando rostro):</label>
                            <input type="file" id="selfiePhoto" accept="image/*" class="file-input" required>
                            <div class="preview-container">
                                <img id="selfiePhotoPreview" class="preview-image" style="display:none;">
                            </div>
                        </div>
                        
                        <button id="submitVerificationBtn">Enviar Solicitud de Verificación</button>
                        <div id="verificationMessage" class="message"></div>
                    </form>
                </div>
            </div>
            
            <!-- Carrito de Compras -->
            <div id="cartSection" class="section cart-section">
                <h2><i class="fas fa-shopping-cart"></i> Carrito de Compras</h2>
                <div id="cartItems"></div>
                <div id="cartTotal" class="cart-total"></div>
                <button id="checkoutBtn" style="display:none;">Proceder al Pago</button>
                <div id="cartMessage" class="message"></div>
            </div>
            
            <!-- Instrucciones de Pago -->
            <div id="paymentInstructions" class="section">
                <h2><i class="fas fa-credit-card"></i> Instrucciones de Pago</h2>
                <div class="instructions-box">
                    <p>Para completar tu compra, por favor realiza el pago a la siguiente dirección de Binance:</p>
                    <div class="wallet-address">bnb1qxy2kgdygjrsqtzq2n0yrf2493p83kkfj43xq7</div>
                    <p>Una vez realizado el pago, haz clic en el botón "Confirmar Pago" para notificar al vendedor.</p>
                    <p>El vendedor te enviará el acceso al producto una vez que el administrador verifique el pago.</p>
                </div>
                <div id="purchaseDetails"></div>
                <button id="confirmPaymentBtn">Confirmar Pago</button>
                <button id="cancelPaymentBtn">Cancelar Compra</button>
                <div id="paymentMessage" class="message"></div>
            </div>
            
            <!-- Mis Compras -->
            <div id="myPurchases" class="section">
                <h2><i class="fas fa-shopping-bag"></i> Mis Compras</h2>
                <div id="purchasesList"></div>
            </div>
            
            <!-- Ventas del Vendedor -->
            <div id="sellerSales" class="section seller-sales">
                <h2><i class="fas fa-chart-line"></i> Mis Ventas</h2>
                
                <!-- Buscador de ventas -->
                <div class="search-container">
                    <input type="text" id="salesSearchInput" class="search-input" placeholder="Buscar venta por ID...">
                    <button class="search-button" id="salesSearchButton">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                
                <div id="salesList"></div>
            </div>
            
            <!-- Panel de Administración -->
            <div id="adminPanel" class="section admin-panel">
                <div class="admin-header">
                    <h2><i class="fas fa-cog"></i> Panel de Administración</h2>
                    <button id="refreshVerifications"><i class="fas fa-sync-alt"></i> Actualizar Solicitudes</button>
                </div>
                <p>Bienvenido al panel de administración. Aquí puedes gestionar las solicitudes de verificación de vendedores y pagos.</p>
                
                <h3 class="admin-section-title">Solicitudes de Verificación Pendientes</h3>
                <div id="verificationsList">
                    <p>Cargando solicitudes...</p>
                </div>
                
                <h3 class="admin-section-title">Pagos Pendientes de Verificación</h3>
                <div id="paymentsList">
                    <p>Cargando pagos...</p>
                </div>
                
                <h3 class="admin-section-title">Vendedores Verificados</h3>
                <div id="verifiedSellersList">
                    <p>Cargando vendedores verificados...</p>
                </div>
                
                <!-- NUEVO: Chat con vendedores -->
                <h3 class="admin-section-title">Chat con Vendedores</h3>
                <div class="admin-sellers-chat">
                    <h4>Lista de Vendedores</h4>
                    <div class="sellers-list" id="sellersList">
                        <p>Cargando vendedores...</p>
                    </div>
                    
                    <div id="sellerChatContainer" style="display:none;">
                        <h4>Chat con: <span id="selectedSellerName"></span></h4>
                        <div class="seller-chat-messages" id="sellerChatMessages">
                            <p>No hay mensajes aún.</p>
                        </div>
                        <div class="seller-chat-input">
                            <input type="text" id="sellerChatInput" placeholder="Escribe un mensaje...">
                            <button class="admin-btn" id="sendSellerMessage">Enviar</button>
                        </div>
                    </div>
                </div>
                
                <!-- NUEVO: Historial de Transacciones -->
                <h3 class="admin-section-title">Historial de Transacciones</h3>
                <div class="transaction-history">
                    <div id="transactionHistory">
                        <p>Cargando historial de transacciones...</p>
                    </div>
                </div>
            </div>
            
            <!-- Sección de Productos -->
            <div id="productsSection" class="section">
                
                <!-- CORRECCIÓN: Botón de publicar producto más pequeño y en esquina derecha -->
                <div class="publish-btn-container">
                    <button id="showPublishForm" class="publish-btn" style="display:none;"><i class="fas fa-plus"></i> Publicar Producto</button>
                </div>
                
                <form id="publishForm" style="display:none;" onsubmit="return false;">
                    <h3>Publicar Nuevo Producto</h3>
                    <div class="form-group">
                        <input type="text" id="productName" placeholder="Nombre del producto" required>
                    </div>
                    <div class="form-group">
                        <textarea id="productDescription" placeholder="Descripción" required></textarea>
                    </div>
                    <div class="form-group">
                        <input type="number" id="productPrice" placeholder="Precio" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <select id="productCategory" required>
                            <option value="">Selecciona categoría</option>
                            <option value="Netflix">Netflix</option>
                            <option value="Canva">Canva</option>
                            <option value="Capcut">Capcut</option>
                            <option value="Spotify">Spotify</option>
                            <option value="Personalizar">Personalizar</option>
                            <option value="Diseño Creativo">Diseño Creativo</option>
                            <option value="Desarrollo Web">Desarrollo Web</option>
                            <option value="Cursos Online">Cursos Online</option>
                        </select>
                    </div>
                    <!-- NUEVO: Campo para garantía del producto -->
                    <div class="form-group">
                        <label>Garantía del producto:</label>
                        <select id="productWarranty" required>
                            <option value="">Selecciona garantía</option>
                            <option value="1 mes">1 mes</option>
                            <option value="2 meses">2 meses</option>
                            <option value="3 meses">3 meses</option>
                            <option value="personalizada">Personalizada</option>
                        </select>
                    </div>
                    <div id="customWarrantyContainer" style="display:none;">
                        <div class="form-group">
                            <input type="text" id="customWarranty" placeholder="Especifica la garantía (ej: 15 días, 6 meses)">
                        </div>
                    </div>
                    <!-- NUEVO: Campo para imagen del producto -->
                    <div class="form-group">
                        <label>Imagen del producto (máximo 1MB):</label>
                        <input type="file" id="productImage" accept="image/*" class="file-input" required>
                        <div class="preview-container">
                            <img id="productImagePreview" class="preview-image" style="display:none;">
                        </div>
                    </div>
                    <button id="publishBtn">Publicar Producto</button>
                    <div id="publishMessage" class="message"></div>
                </form>
                
                <h3>Productos Publicados</h3>
                <div id="productsList" class="products-grid"></div>
            </div>
            
            <!-- Estado de Conexión -->
            <div id="connectionStatus" class="message"></div>
        </div>
    </div>

    <!-- NUEVO: Chat de soporte -->
    <div class="chat-toggle" id="chatToggle">
        <i class="fas fa-headset"></i>
        <span id="chatBadge" class="chat-badge" style="display:none;">0</span>
    </div>
    
    <div class="chat-support" id="chatSupport">
        <div class="chat-header">
            <div class="chat-title">Soporte DigitalMarket</div>
            <button class="chat-close" id="chatClose">×</button>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chatInput" placeholder="Escribe tu mensaje...">
            <button class="chat-send" id="chatSend"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
    
    <!-- NUEVO: Panel de notificaciones -->
    <div class="notifications-panel" id="notificationsPanel">
        <div class="notifications-header">
            <div class="notifications-title">Notificaciones</div>
            <button class="notifications-close" id="notificationsClose">×</button>
        </div>
        <div class="notifications-list" id="notificationsList"></div>
    </div>

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBam7G9fvfOqEphEUnhWtyTrVuFe29e9Rw",
            authDomain: "suscripcionesgiftcard.firebaseapp.com",
            projectId: "suscripcionesgiftcard",
            databaseURL: "https://suscripcionesgiftcard-default-rtdb.firebaseio.com",
            messagingSenderId: "885068568568",
            appId: "1:885068568568:web:32f101738cf94ffa3c280d",
            measurementId: "G-25BDNLG3QV"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const database = firebase.database();
        
        // Variables de estado
        let isDatabaseConnected = false;
        let currentUserData = null;
        let isAdmin = false;
        let cart = [];
        let currentPurchase = null;
        let selectedCategory = null;
        let searchTerm = '';
        let selectedSellerId = null; // Para el chat con vendedores
        
        // Referencias a elementos del DOM
        const authSection = document.getElementById('authSection');
        const authTitle = document.getElementById('authTitle');
        const authToggleBtn = document.getElementById('authToggleBtn');
        const authToggleText = document.getElementById('authToggleText');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const userInfo = document.getElementById('userInfo');
        const userName = document.getElementById('userName');
        const userRole = document.getElementById('userRole');
        const userEmail = document.getElementById('userEmail');
        const sellerVerificationSection = document.getElementById('sellerVerificationSection');
        const sellerStatus = document.getElementById('sellerStatus');
        const showVerificationFormBtn = document.getElementById('showVerificationForm');
        const verificationForm = document.getElementById('verificationForm');
        const adminPanel = document.getElementById('adminPanel');
        const verificationsList = document.getElementById('verificationsList');
        const paymentsList = document.getElementById('paymentsList');
        const verifiedSellersList = document.getElementById('verifiedSellersList');
        const showPublishFormBtn = document.getElementById('showPublishForm');
        const publishForm = document.getElementById('publishForm');
        const productsList = document.getElementById('productsList');
        const connectionStatus = document.getElementById('connectionStatus');
        const cartSection = document.getElementById('cartSection');
        const cartItems = document.getElementById('cartItems');
        const cartTotal = document.getElementById('cartTotal');
        const checkoutBtn = document.getElementById('checkoutBtn');
        const cartMessage = document.getElementById('cartMessage');
        const paymentInstructions = document.getElementById('paymentInstructions');
        const purchaseDetails = document.getElementById('purchaseDetails');
        const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');
        const cancelPaymentBtn = document.getElementById('cancelPaymentBtn');
        const paymentMessage = document.getElementById('paymentMessage');
        const myPurchase = document.getElementById('myPurchases');
        const purchasesList = document.getElementById('purchasesList');
        const sellerSales = document.getElementById('sellerSales');
        const salesList = document.getElementById('salesList');
        const logoutBtn = document.getElementById('logoutBtn');
        const navLogoutBtn = document.getElementById('navLogoutBtn');
        
        // Referencias al menú
        const hamburger = document.querySelector('.hamburger');
        const navMenu = document.querySelector('.nav-menu');
        const closeBtn = document.querySelector('.close-btn');
        const adminNavItem = document.getElementById('adminNavItem');
        const salesNavItem = document.getElementById('salesNavItem');
        const purchasesNavItem = document.getElementById('purchasesNavItem');
        const cartNavItem = document.getElementById('cartNavItem');
        const logoutNavItem = document.getElementById('logoutNavItem');
        const sellerNavItem = document.getElementById('sellerNavItem');
        const userInfoNavItem = document.getElementById('userInfoNavItem');
        const notificationsNavItem = document.getElementById('notificationsNavItem');
        const supportNavItem = document.getElementById('supportNavItem');
        const navLinks = document.querySelectorAll('.nav-link');
        const sections = document.querySelectorAll('.section');
        
        // Referencias a elementos móviles
        const mobileUserName = document.getElementById('mobileUserName');
        const mobileUserEmail = document.getElementById('mobileUserEmail');
        const mobileUserRole = document.getElementById('mobileUserRole');
        const mobileSellerStatus = document.getElementById('mobileSellerStatus');
        const mobileShowVerificationFormBtn = document.getElementById('mobileShowVerificationForm');
        
        // Nueva referencia para el botón de vendedor en web
        const showVerificationFormWebBtn = document.getElementById('showVerificationFormWeb');
        
        // Nueva referencia para mostrar información de usuario en web
        const showUserInfoBtn = document.getElementById('showUserInfo');
        
        // CORRECCIÓN: Referencias para el formulario móvil
        const mobileVerificationContainer = document.getElementById('mobileVerificationContainer');
        const mobileVerificationForm = document.getElementById('mobileVerificationForm');
        const mobileSubmitVerificationBtn = document.getElementById('mobileSubmitVerificationBtn');
        const mobileVerificationMessage = document.getElementById('mobileVerificationMessage');
        const mobileVerificationConfirmation = document.getElementById('mobileVerificationConfirmation');
        const mobileBackToMenu = document.getElementById('mobileBackToMenu');
        
        // NUEVO: Referencias para la garantía
        const productWarranty = document.getElementById('productWarranty');
        const customWarrantyContainer = document.getElementById('customWarrantyContainer');
        const customWarranty = document.getElementById('customWarranty');
        
        // NUEVO: Referencias para categorías
        const categoriesList = document.getElementById('categoriesList');
        const mobileCategoriesToggle = document.getElementById('mobileCategoriesToggle');
        const mobileCategories = document.getElementById('mobileCategories');
        const mobileCategoriesList = document.getElementById('mobileCategoriesList');
        
        // NUEVO: Referencia para el historial de transacciones
        const transactionHistory = document.getElementById('transactionHistory');
        
        // NUEVO: Referencias para búsqueda
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const salesSearchInput = document.getElementById('salesSearchInput');
        const salesSearchButton = document.getElementById('salesSearchButton');
        
        // NUEVO: Referencias para chat de soporte
        const chatToggle = document.getElementById('chatToggle');
        const chatSupport = document.getElementById('chatSupport');
        const chatClose = document.getElementById('chatClose');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const chatSend = document.getElementById('chatSend');
        const chatBadge = document.getElementById('chatBadge');
        
        // NUEVO: Referencias para notificaciones
        const notificationsPanel = document.getElementById('notificationsPanel');
        const notificationsClose = document.getElementById('notificationsClose');
        const notificationsList = document.getElementById('notificationsList');
        const navNotificationsCount = document.getElementById('navNotificationsCount');
        const showNotificationsBtn = document.getElementById('showNotifications');
        const showSupportMobileBtn = document.getElementById('showSupportMobile');
        
        // NUEVO: Referencia para contador del carrito
        const navCartCount = document.getElementById('navCartCount');
        
        // NUEVO: Referencias para el chat con vendedores
        const sellersList = document.getElementById('sellersList');
        const sellerChatContainer = document.getElementById('sellerChatContainer');
        const selectedSellerName = document.getElementById('selectedSellerName');
        const sellerChatMessages = document.getElementById('sellerChatMessages');
        const sellerChatInput = document.getElementById('sellerChatInput');
        const sendSellerMessageBtn = document.getElementById('sendSellerMessage');
        
        // CORRECCIÓN: Variable para evitar duplicación de productos
        let productsLoaded = false;
        
        // NUEVO: Variables para el chat
        let supportChatOpen = false;
        let unreadMessages = 0;
        let unreadNotifications = 0;
        
        // Funcionalidad del menú hamburguesa
        hamburger.addEventListener('click', () => {
            navMenu.classList.add('active');
            closeBtn.style.display = 'block';
        });
        
        closeBtn.addEventListener('click', () => {
            navMenu.classList.remove('active');
            closeBtn.style.display = 'none';
        });
        
        // Navegación entre secciones
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetSection = link.getAttribute('data-section');
                
                // Ocultar todas las secciones
                sections.forEach(section => {
                    section.classList.remove('active');
                });
                
                // Ocultar también la sección de información de usuario
                userInfo.classList.remove('active');
                
                // Ocultar formulario móvil
                mobileVerificationContainer.style.display = 'none';
                
                // Mostrar la sección seleccionada
                document.getElementById(targetSection).classList.add('active');
                
                // Cargar datos específicos según la sección
                if (targetSection === 'sellerSales') {
                    loadSellerSales();
                } else if (targetSection === 'myPurchases') {
                    loadUserPurchases();
                } else if (targetSection === 'adminPanel') {
                    loadVerificationRequests();
                    loadPendingPayments();
                    loadVerifiedSellers();
                    loadTransactionHistory();
                    loadSellersForChat(); // Cargar vendedores para el chat
                } else if (targetSection === 'productsSection') {
                    // CORRECCIÓN: Evitar duplicación de productos
                    if (!productsLoaded) {
                        loadProducts();
                        loadCategories();
                        productsLoaded = true;
                    }
                }
                
                // Cerrar menú en móvil
                navMenu.classList.remove('active');
                closeBtn.style.display = 'none';
            });
        });
        
        // Mostrar información de usuario al hacer clic en "Mi Cuenta" (web)
        showUserInfoBtn.addEventListener('click', (e) => {
            e.preventDefault();
            
            // Ocultar todas las secciones
            sections.forEach(section => {
                section.classList.remove('active');
            });
            
            // Ocultar formulario móvil
            mobileVerificationContainer.style.display = 'none';
            
            // Mostrar la sección de información de usuario
            userInfo.classList.add('active');
            
            // Cerrar menú en móvil
            navMenu.classList.remove('active');
            closeBtn.style.display = 'none';
        });
        
        // CORRECCIÓN: Mostrar formulario de vendedor en móvil
        mobileShowVerificationFormBtn.addEventListener('click', (e) => {
            e.preventDefault();
            
            // Ocultar todas las secciones
            sections.forEach(section => {
                section.classList.remove('active');
            });
            
            // Ocultar sección de usuario
            userInfo.classList.remove('active');
            
            // Mostrar formulario móvil
            mobileVerificationContainer.style.display = 'block';
            mobileVerificationForm.style.display = 'block';
            mobileVerificationConfirmation.style.display = 'none';
            
            // Cerrar menú en móvil
            navMenu.classList.remove('active');
            closeBtn.style.display = 'none';
        });
        
        // Alternar entre login y registro
        authToggleBtn.addEventListener('click', () => {
            const isLoginVisible = loginForm.style.display !== 'none';
            
            if (isLoginVisible) {
                // Cambiar a registro
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                authTitle.textContent = 'Crear Cuenta';
                authToggleText.innerHTML = '¿Ya tienes cuenta? <button class="auth-toggle" id="authToggleBtn">Inicia sesión aquí</button>';
            } else {
                // Cambiar a login
                registerForm.style.display = 'none';
                loginForm.style.display = 'block';
                authTitle.textContent = 'Iniciar Sesión';
                authToggleText.innerHTML = '¿No tienes cuenta? <button class="auth-toggle" id="authToggleBtn">Regístrate aquí</button>';
            }
        });
        
        // NUEVO: Mostrar/ocultar categorías en móvil
        mobileCategoriesToggle.addEventListener('click', () => {
            mobileCategories.classList.toggle('active');
        });
        
        // NUEVO: Mostrar/ocultar campo de garantía personalizada
        productWarranty.addEventListener('change', () => {
            if (productWarranty.value === 'personalizada') {
                customWarrantyContainer.style.display = 'block';
                customWarranty.required = true;
            } else {
                customWarrantyContainer.style.display = 'none';
                customWarranty.required = false;
            }
        });
        
        // NUEVO: Funcionalidad de búsqueda de productos
        searchButton.addEventListener('click', () => {
            searchTerm = searchInput.value.trim();
            loadProducts();
        });
        
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchTerm = searchInput.value.trim();
                loadProducts();
            }
        });
        
        // NUEVO: Funcionalidad de búsqueda de ventas
        salesSearchButton.addEventListener('click', () => {
            const searchTerm = salesSearchInput.value.trim();
            loadSellerSales(searchTerm);
        });
        
        salesSearchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const searchTerm = salesSearchInput.value.trim();
                loadSellerSales(searchTerm);
            }
        });
        
        // NUEVO: Funcionalidad del chat de soporte
        chatToggle.addEventListener('click', () => {
            if (supportChatOpen) {
                chatSupport.style.display = 'none';
                supportChatOpen = false;
            } else {
                chatSupport.style.display = 'flex';
                supportChatOpen = true;
                unreadMessages = 0;
                chatBadge.style.display = 'none';
                loadSupportMessages();
            }
        });
        
        chatClose.addEventListener('click', () => {
            chatSupport.style.display = 'none';
            supportChatOpen = false;
        });
        
        chatSend.addEventListener('click', sendSupportMessage);
        
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendSupportMessage();
            }
        });
        
        // NUEVO: Funcionalidad de notificaciones
        showNotificationsBtn.addEventListener('click', (e) => {
            e.preventDefault();
            notificationsPanel.style.display = 'flex';
            unreadNotifications = 0;
            navNotificationsCount.style.display = 'none';
            loadNotifications();
        });
        
        notificationsClose.addEventListener('click', () => {
            notificationsPanel.style.display = 'none';
        });
        
        // NUEVO: Mostrar soporte en móvil
        showSupportMobileBtn.addEventListener('click', (e) => {
            e.preventDefault();
            chatSupport.style.display = 'flex';
            supportChatOpen = true;
            unreadMessages = 0;
            chatBadge.style.display = 'none';
            loadSupportMessages();
            
            // Cerrar menú en móvil
            navMenu.classList.remove('active');
            closeBtn.style.display = 'none';
        });
        
        // NUEVO: Funcionalidad del chat con vendedores
        sendSellerMessageBtn.addEventListener('click', sendMessageToSeller);
        
        sellerChatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessageToSeller();
            }
        });
        
        // Función para observar elementos y aplicar animación
        function observeElements() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                    }
                });
            }, { threshold: 0.1 });
            
            // Observar todos los productos
            document.querySelectorAll('.product-card').forEach(card => {
                observer.observe(card);
            });
        }
        
        // Actualizar la visibilidad del menú según el estado del usuario
        function updateMenuVisibility() {
            const user = auth.currentUser;
            
            // Mostrar opciones según el estado del usuario
            if (user) {
                // Usuario autenticado
                purchasesNavItem.style.display = 'block';
                cartNavItem.style.display = 'block';
                logoutNavItem.style.display = 'block';
                userInfoNavItem.style.display = 'block';
                notificationsNavItem.style.display = 'block';
                supportNavItem.style.display = 'block';
                
                if (currentUserData) {
                    // Mostrar opción de vendedor solo si no es vendedor ya verificado
                    if (currentUserData.role !== 'seller') {
                        sellerNavItem.style.display = 'block';
                    } else {
                        sellerNavItem.style.display = 'none';
                    }
                    
                    if (currentUserData.role === 'seller') {
                        salesNavItem.style.display = 'block';
                    }
                    
                    if (isAdmin) {
                        adminNavItem.style.display = 'block';
                    }
                }
            } else {
                // Usuario no autenticado
                adminNavItem.style.display = 'none';
                salesNavItem.style.display = 'none';
                purchasesNavItem.style.display = 'none';
                cartNavItem.style.display = 'none';
                logoutNavItem.style.display = 'none';
                sellerNavItem.style.display = 'none';
                userInfoNavItem.style.display = 'none';
                notificationsNavItem.style.display = 'none';
                supportNavItem.style.display = 'none';
            }
        }
        
        // Actualizar información de usuario en el menú móvil
        function updateMobileUserInfo() {
            if (currentUserData) {
                mobileUserName.textContent = currentUserData.name || currentUserData.email;
                mobileUserEmail.textContent = currentUserData.email;
                mobileUserRole.textContent = currentUserData.role === 'seller' ? 'Vendedor Verificado' : 'Comprador';
                
                // Mostrar estado de verificación en móvil
                const verificationStatus = currentUserData.sellerVerification?.status || 'not_requested';
                
                if (verificationStatus === 'not_requested') {
                    mobileSellerStatus.innerHTML = '';
                    mobileShowVerificationFormBtn.style.display = 'block';
                    mobileShowVerificationFormBtn.textContent = 'Convertirme en vendedor';
                } else if (verificationStatus === 'pending') {
                    mobileSellerStatus.textContent = 'Estado: Pendiente de revisión';
                    mobileSellerStatus.className = 'mobile-verification-status status-pending';
                    mobileShowVerificationFormBtn.style.display = 'none';
                } else if (verificationStatus === 'approved') {
                    mobileSellerStatus.textContent = 'Estado: ¡Verificación aprobada!';
                    mobileSellerStatus.className = 'mobile-verification-status status-approved';
                    mobileShowVerificationFormBtn.style.display = 'none';
                } else if (verificationStatus === 'rejected') {
                    mobileSellerStatus.textContent = 'Estado: Solicitud rechazada. Contacta con soporte.';
                    mobileSellerStatus.className = 'mobile-verification-status status-rejected';
                    mobileShowVerificationFormBtn.style.display = 'none';
                }
            }
        }
        
        // NUEVO: Cargar categorías
        function loadCategories() {
            // Categorías predefinidas
            const categories = [
                "Netflix", "Canva", "Capcut", "Spotify", "Personalizar", 
                "Diseño Creativo", "Desarrollo Web", "Cursos Online"
            ];
            
            // Limpiar listas
            categoriesList.innerHTML = '';
            mobileCategoriesList.innerHTML = '';
            
            // Agregar opción "Todas las categorías"
            const allCategoriesItem = document.createElement('div');
            allCategoriesItem.className = `category-item ${selectedCategory === null ? 'active' : ''}`;
            allCategoriesItem.innerHTML = `
                <span>Todas las categorías</span>
                <span class="category-count" id="allCategoriesCount">0</span>
            `;
            allCategoriesItem.addEventListener('click', () => {
                selectedCategory = null;
                loadProducts();
                updateCategorySelection();
            });
            
            categoriesList.appendChild(allCategoriesItem);
            
            // Clonar para móvil
            const mobileAllCategoriesItem = allCategoriesItem.cloneNode(true);
            mobileCategoriesList.appendChild(mobileAllCategoriesItem);
            
            // Agregar cada categoría
            categories.forEach(category => {
                const categoryItem = document.createElement('div');
                categoryItem.className = `category-item ${selectedCategory === category ? 'active' : ''}`;
                categoryItem.innerHTML = `
                    <span>${category}</span>
                    <span class="category-count" id="${category.replace(/\s+/g, '')}Count">0</span>
                `;
                categoryItem.addEventListener('click', () => {
                    selectedCategory = category;
                    loadProducts();
                    updateCategorySelection();
                });
                
                categoriesList.appendChild(categoryItem);
                
                // Clonar para móvil
                const mobileCategoryItem = categoryItem.cloneNode(true);
                mobileCategoriesList.appendChild(mobileCategoryItem);
            });
            
            // Actualizar contadores
            updateCategoryCounts();
        }
        
        // NUEVO: Actualizar contadores de categorías
        function updateCategoryCounts() {
            db.collection('productos')
                .where('status', '==', 'active')
                .get()
                .then((querySnapshot) => {
                    const counts = {};
                    
                    // Inicializar contadores
                    const categories = [
                        "Netflix", "Canva", "Capcut", "Spotify", "Personalizar", 
                        "Diseño Creativo", "Desarrollo Web", "Cursos Online"
                    ];
                    
                    categories.forEach(category => {
                        counts[category] = 0;
                    });
                    
                    // Contar productos por categoría
                    querySnapshot.forEach((doc) => {
                        const product = doc.data();
                        if (counts[product.category] !== undefined) {
                            counts[product.category]++;
                        }
                    });
                    
                    // Actualizar contadores en la interfaz
                    document.getElementById('allCategoriesCount').textContent = querySnapshot.size;
                    
                    categories.forEach(category => {
                        const element = document.getElementById(`${category.replace(/\s+/g, '')}Count`);
                        if (element) {
                            element.textContent = counts[category];
                        }
                    });
                    
                    // Actualizar también en móvil
                    const mobileElements = document.querySelectorAll('.mobile-categories .category-count');
                    if (mobileElements.length > 0) {
                        mobileElements[0].textContent = querySnapshot.size;
                        
                        categories.forEach((category, index) => {
                            if (mobileElements[index + 1]) {
                                mobileElements[index + 1].textContent = counts[category];
                            }
                        });
                    }
                })
                .catch((error) => {
                    console.error("Error al contar productos por categoría:", error);
                });
        }
        
        // NUEVO: Actualizar selección de categorías
        function updateCategorySelection() {
            // Actualizar en desktop
            document.querySelectorAll('.categories-sidebar .category-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Actualizar en móvil
            document.querySelectorAll('.mobile-categories .category-item').forEach(item => {
                item.classList.remove('active');
            });
            
            if (selectedCategory === null) {
                // Seleccionar "Todas las categorías"
                document.querySelectorAll('.category-item')[0].classList.add('active');
                document.querySelectorAll('.category-item')[8].classList.add('active');
            } else {
                // Encontrar y seleccionar la categoría específica
                const categoryItems = document.querySelectorAll('.category-item');
                for (let i = 0; i < categoryItems.length; i++) {
                    if (categoryItems[i].textContent.includes(selectedCategory)) {
                        categoryItems[i].classList.add('active');
                        break;
                    }
                }
            }
        }
        
        // Verificar conexión a Firebase
        function checkDatabaseConnection() {
            const connectedRef = database.ref(".info/connected");
            connectedRef.on("value", function(snap) {
                if (snap.val() === true) {
                    isDatabaseConnected = true;
                    showMessage("Conectado a la base de datos", "success", connectionStatus);
                } else {
                    isDatabaseConnected = false;
                    showMessage("Modo sin conexión: usando almacenamiento local", "error", connectionStatus);
                }
            });
        }
        
        // Mostrar mensajes
        function showMessage(message, type, element) {
            element.textContent = message;
            element.className = `message ${type}`;
            element.style.display = 'block';
            
            // Ocultar después de 5 segundos
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }
        
        // Mostrar notificación de administración
        function showAdminNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `admin-notification notification-${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Ocultar después de 5 segundos
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
        
        // Convertir imagen a Base64
        function convertImageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        
        // Vista previa de imágenes
        document.getElementById('idPhoto').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('idPhotoPreview').src = e.target.result;
                    document.getElementById('idPhotoPreview').style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        });
        
        document.getElementById('selfiePhoto').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('selfiePhotoPreview').src = e.target.result;
                    document.getElementById('selfiePhotoPreview').style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        });
        
        // NUEVO: Vista previa de imagen del producto
        document.getElementById('productImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('productImagePreview').src = e.target.result;
                    document.getElementById('productImagePreview').style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        });
        
        // CORRECCIÓN: Vista previa de imágenes para formulario móvil
        document.getElementById('mobileIdPhoto').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('mobileIdPhotoPreview').src = e.target.result;
                    document.getElementById('mobileIdPhotoPreview').style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        });
        
        document.getElementById('mobileSelfiePhoto').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('mobileSelfiePhotoPreview').src = e.target.result;
                    document.getElementById('mobileSelfiePhotoPreview').style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        });
        
        // Iniciar sesión
        document.getElementById('loginBtn').addEventListener('click', () => {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const messageElement = document.getElementById('loginMessage');
            
            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    showMessage("¡Inicio de sesión exitoso!", "success", messageElement);
                })
                .catch((error) => {
                    showMessage(getErrorMessage(error.code), "error", messageElement);
                });
        });
        
        // Registrarse
        document.getElementById('registerBtn').addEventListener('click', () => {
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            const messageElement = document.getElementById('registerMessage');
            
            // Validaciones
            if (password !== confirmPassword) {
                showMessage("Las contraseñas no coinciden", "error", messageElement);
                return;
            }
            
            if (password.length < 6) {
                showMessage("La contraseña debe tener al menos 6 caracteres", "error", messageElement);
                return;
            }
            
            // Crear usuario
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    
                    // Actualizar perfil
                    return user.updateProfile({
                        displayName: name
                    }).then(() => {
                        // Guardar información adicional
                        return db.collection('users').doc(user.uid).set({
                            name: name,
                            email: email,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            role: 'buyer',
                            sellerVerification: {
                                status: 'not_requested',
                                requestedAt: null
                            }
                        });
                    });
                })
                .then(() => {
                    showMessage("¡Cuenta creada con éxito!", "success", messageElement);
                    // Cambiar a formulario de login
                    registerForm.style.display = 'none';
                    loginForm.style.display = 'block';
                    authTitle.textContent = 'Iniciar Sesión';
                    authToggleText.innerHTML = '¿No tienes cuenta? <button class="auth-toggle" id="authToggleBtn">Regístrate aquí</button>';
                })
                .catch((error) => {
                    showMessage(getErrorMessage(error.code), "error", messageElement);
                });
        });
        
        // Cerrar sesión
        function logoutUser() {
            auth.signOut();
            cart = [];
            updateCartUI();
            // CORRECCIÓN: Resetear variable de productos cargados
            productsLoaded = false;
        }
        
        logoutBtn.addEventListener('click', logoutUser);
        navLogoutBtn.addEventListener('click', logoutUser);
        
        // Publicar producto
        document.getElementById('publishBtn').addEventListener('click', async () => {
            const name = document.getElementById('productName').value;
            const description = document.getElementById('productDescription').value;
            const price = parseFloat(document.getElementById('productPrice').value);
            const category = document.getElementById('productCategory').value;
            const warranty = productWarranty.value === 'personalizada' ? customWarranty.value : productWarranty.value;
            const productImage = document.getElementById('productImage').files[0];
            const messageElement = document.getElementById('publishMessage');
            
            // Validaciones
            if (!name || !description || !price || !category || !warranty || !productImage) {
                showMessage("Por favor, completa todos los campos", "error", messageElement);
                return;
            }
            
            // Validar tamaño de imagen (máximo 1MB)
            const maxSize = 1 * 1024 * 1024; // 1MB
            if (productImage.size > maxSize) {
                showMessage("La imagen del producto debe ser menor a 1MB", "error", messageElement);
                return;
            }
            
            const user = auth.currentUser;
            if (!user) {
                showMessage("Debes iniciar sesión para publicar productos", "error", messageElement);
                return;
            }
            
            // Verificar si es vendedor verificado
            if (currentUserData.role !== 'seller') {
                showMessage("Debes ser un vendedor verificado para publicar productos", "error", messageElement);
                return;
            }
            
            try {
                // Convertir imagen a Base64
                const productImageBase64 = await convertImageToBase64(productImage);
                
                // Guardar producto
                await db.collection('productos').add({
                    name: name,
                    description: description,
                    price: price,
                    category: category,
                    warranty: warranty,
                    image: productImageBase64,
                    userId: user.uid,
                    userName: user.displayName || user.email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'active'
                });
                
                showMessage("¡Producto publicado con éxito!", "success", messageElement);
                document.getElementById('publishForm').reset();
                document.getElementById('productImagePreview').style.display = 'none';
                customWarrantyContainer.style.display = 'none';
                loadProducts();
                updateCategoryCounts();
            } catch (error) {
                showMessage("Error al publicar el producto: " + error.message, "error", messageElement);
            }
        });
        
        // CORRECCIÓN: Enviar solicitud de verificación desde móvil
        mobileSubmitVerificationBtn.addEventListener('click', async () => {
            const fullName = document.getElementById('mobileFullName').value;
            const country = document.getElementById('mobileCountry').value;
            const idNumber = document.getElementById('mobileIdNumber').value;
            const binanceId = document.getElementById('mobileBinanceId').value;
            const businessName = document.getElementById('mobileBusinessName').value;
            const businessDescription = document.getElementById('mobileBusinessDescription').value;
            const phoneNumber = document.getElementById('mobilePhoneNumber').value;
            const idPhoto = document.getElementById('mobileIdPhoto').files[0];
            const selfiePhoto = document.getElementById('mobileSelfiePhoto').files[0];
            const messageElement = mobileVerificationMessage;
            
            // Validaciones
            if (!fullName || !country || !idNumber || !binanceId || !phoneNumber || !idPhoto || !selfiePhoto) {
                showMessage("Por favor, completa todos los campos obligatorios", "error", messageElement);
                return;
            }
            
            // Validar tamaño de imágenes (máximo 2MB cada una)
            const maxSize = 2 * 1024 * 1024; // 2MB
            if (idPhoto.size > maxSize) {
                showMessage("La foto del documento debe ser menor a 2MB", "error", messageElement);
                return;
            }
            
            if (selfiePhoto.size > maxSize) {
                showMessage("El selfie debe ser menor a 2MB", "error", messageElement);
                return;
            }
            
            const user = auth.currentUser;
            if (!user) {
                showMessage("Debes iniciar sesión para enviar una solicitud", "error", messageElement);
                return;
            }
            
            try {
                // Convertir imágenes a Base64
                const idPhotoBase64 = await convertImageToBase64(idPhoto);
                const selfiePhotoBase64 = await convertImageToBase64(selfiePhoto);
                
                // Enviar solicitud de verificación
                await db.collection('sellerVerifications').add({
                    userId: user.uid,
                    userName: user.displayName || user.email,
                    userEmail: user.email,
                    fullName: fullName,
                    country: country,
                    idNumber: idNumber,
                    binanceId: binanceId,
                    businessName: businessName,
                    businessDescription: businessDescription,
                    phoneNumber: phoneNumber,
                    idPhoto: idPhotoBase64,
                    selfiePhoto: selfiePhotoBase64,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    reviewedAt: null,
                    reviewedBy: null
                });
                
                // Actualizar estado del usuario
                await db.collection('users').doc(user.uid).update({
                    'sellerVerification.status': 'pending',
                    'sellerVerification.requestedAt': firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Mostrar mensaje de confirmación en lugar del formulario
                mobileVerificationForm.style.display = 'none';
                mobileVerificationConfirmation.style.display = 'block';
                
                loadUserData(user.uid);
            } catch (error) {
                showMessage("Error al enviar la solicitud: " + error.message, "error", messageElement);
            }
        });
        
        // Volver al menú desde la confirmación móvil
        mobileBackToMenu.addEventListener('click', () => {
            mobileVerificationContainer.style.display = 'none';
            showSection('productsSection');
        });
        
        // Enviar solicitud de verificación
        document.getElementById('submitVerificationBtn').addEventListener('click', async () => {
            const fullName = document.getElementById('fullName').value;
            const country = document.getElementById('country').value;
            const idNumber = document.getElementById('idNumber').value;
            const binanceId = document.getElementById('binanceId').value;
            const businessName = document.getElementById('businessName').value;
            const businessDescription = document.getElementById('businessDescription').value;
            const phoneNumber = document.getElementById('phoneNumber').value;
            const idPhoto = document.getElementById('idPhoto').files[0];
            const selfiePhoto = document.getElementById('selfiePhoto').files[0];
            const messageElement = document.getElementById('verificationMessage');
            
            // Validaciones
            if (!fullName || !country || !idNumber || !binanceId || !phoneNumber || !idPhoto || !selfiePhoto) {
                showMessage("Por favor, completa todos los campos obligatorios", "error", messageElement);
                return;
            }
            
            // Validar tamaño de imágenes (máximo 2MB cada una)
            const maxSize = 2 * 1024 * 1024; // 2MB
            if (idPhoto.size > maxSize) {
                showMessage("La foto del documento debe ser menor a 2MB", "error", messageElement);
                return;
            }
            
            if (selfiePhoto.size > maxSize) {
                showMessage("El selfie debe ser menor a 2MB", "error", messageElement);
                return;
            }
            
            const user = auth.currentUser;
            if (!user) {
                showMessage("Debes iniciar sesión para enviar una solicitud", "error", messageElement);
                return;
            }
            
            try {
                // Convertir imágenes a Base64
                const idPhotoBase64 = await convertImageToBase64(idPhoto);
                const selfiePhotoBase64 = await convertImageToBase64(selfiePhoto);
                
                // Enviar solicitud de verificación
                await db.collection('sellerVerifications').add({
                    userId: user.uid,
                    userName: user.displayName || user.email,
                    userEmail: user.email,
                    fullName: fullName,
                    country: country,
                    idNumber: idNumber,
                    binanceId: binanceId,
                    businessName: businessName,
                    businessDescription: businessDescription,
                    phoneNumber: phoneNumber,
                    idPhoto: idPhotoBase64,
                    selfiePhoto: selfiePhotoBase64,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    reviewedAt: null,
                    reviewedBy: null
                });
                
                // Actualizar estado del usuario
                await db.collection('users').doc(user.uid).update({
                    'sellerVerification.status': 'pending',
                    'sellerVerification.requestedAt': firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showMessage("¡Solicitud enviada con éxito! Serás notificado cuando sea revisada.", "success", messageElement);
                verificationForm.style.display = 'none';
                loadUserData(user.uid);
            } catch (error) {
                showMessage("Error al enviar la solicitud: " + error.message, "error", messageElement);
            }
        });
        
        // Mostrar formulario de verificación desde móvil
        mobileShowVerificationFormBtn.addEventListener('click', () => {
            // Cerrar menú móvil
            navMenu.classList.remove('active');
            closeBtn.style.display = 'none';
            
            // Mostrar formulario móvil
            sections.forEach(section => {
                section.classList.remove('active');
            });
            userInfo.classList.remove('active');
            mobileVerificationContainer.style.display = 'block';
            mobileVerificationForm.style.display = 'block';
            mobileVerificationConfirmation.style.display = 'none';
        });
        
        // Mostrar formulario de verificación desde web
        showVerificationFormWebBtn.addEventListener('click', () => {
            // Mostrar sección de información de usuario con el formulario de verificación
            sections.forEach(section => {
                section.classList.remove('active');
            });
            userInfo.classList.add('active');
            sellerVerificationSection.style.display = 'block';
            verificationForm.style.display = 'block';
        });
        
        // Mostrar formulario de verificación desde el botón en la sección de usuario
        showVerificationFormBtn.addEventListener('click', () => {
            verificationForm.style.display = verificationForm.style.display === 'none' ? 'block' : 'none';
        });
        
        // Agregar producto al carrito
        function addToCart(product) {
            const existingItem = cart.find(item => item.id === product.id);
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: 1,
                    sellerId: product.userId,
                    sellerName: product.userName
                });
            }
            
            updateCartUI();
            showMessage("Producto agregado al carrito", "success", cartMessage);
        }
        
        // Actualizar interfaz del carrito
        function updateCartUI() {
            cartItems.innerHTML = '';
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<p>Tu carrito está vacío</p>';
                cartTotal.textContent = '';
                checkoutBtn.style.display = 'none';
                navCartCount.style.display = 'none';
                return;
            }
            
            let total = 0;
            let totalItems = 0;
            
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                totalItems += item.quantity;
                
                const cartItemElement = document.createElement('div');
                cartItemElement.className = 'cart-item';
                cartItemElement.innerHTML = `
                    <div>
                        <h4>${item.name}</h4>
                        <p>Precio: $${item.price.toFixed(2)} x ${item.quantity}</p>
                        <p>Vendedor: ${item.sellerName}</p>
                    </div>
                    <div>
                        <p>$${itemTotal.toFixed(2)}</p>
                        <button class="remove-from-cart" data-id="${item.id}">Eliminar</button>
                    </div>
                `;
                cartItems.appendChild(cartItemElement);
            });
            
            cartTotal.textContent = `Total: $${total.toFixed(2)}`;
            checkoutBtn.style.display = 'block';
            
            // Actualizar contador del carrito en la navegación
            navCartCount.textContent = totalItems;
            navCartCount.style.display = 'block';
            
            // Añadir event listeners a los botones de eliminar
            document.querySelectorAll('.remove-from-cart').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const productId = e.target.getAttribute('data-id');
                    removeFromCart(productId);
                });
            });
        }
        
        // Eliminar producto del carrito
        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            updateCartUI();
            showMessage("Producto eliminado del carrito", "success", cartMessage);
        }
        
        // Proceder al pago
        checkoutBtn.addEventListener('click', () => {
            if (cart.length === 0) {
                showMessage("Tu carrito está vacío", "error", cartMessage);
                return;
            }
            
            // Calcular total
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            // CORRECCIÓN: Agregar $2 adicionales por impuestos y servicio de envío
            const additionalFees = 2.00;
            const total = subtotal + additionalFees;
            
            // Mostrar instrucciones de pago
            showSection('paymentInstructions');
            
            // Mostrar detalles de la compra con desglose de cargos
            purchaseDetails.innerHTML = `
                <h3>Resumen de tu compra</h3>
                <div class="additional-fees">
                    <h4>Desglose de cargos</h4>
                    <div class="fee-breakdown">
                        <span>Subtotal:</span>
                        <span>$${subtotal.toFixed(2)}</span>
                    </div>
                    <div class="fee-breakdown">
                        <span>Impuestos y servicio de envío:</span>
                        <span>$${additionalFees.toFixed(2)}</span>
                    </div>
                    <div class="fee-breakdown fee-total">
                        <span>Total a pagar:</span>
                        <span>$${total.toFixed(2)}</span>
                    </div>
                </div>
                <p><strong>Productos:</strong></p>
                <ul>
                    ${cart.map(item => `<li>${item.name} - $${item.price.toFixed(2)} x ${item.quantity}</li>`).join('')}
                </ul>
            `;
            
            // Guardar compra actual
            currentPurchase = {
                items: [...cart],
                subtotal: subtotal,
                additionalFees: additionalFees,
                total: total,
                status: 'pending_payment',
                createdAt: new Date()
            };
        });
        
        // Confirmar pago
        confirmPaymentBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) {
                showMessage("Debes iniciar sesión para confirmar el pago", "error", paymentMessage);
                return;
            }
            
            try {
                // Crear la compra en la base de datos
                const purchaseRef = await db.collection('purchases').add({
                    userId: user.uid,
                    userName: user.displayName || user.email,
                    items: currentPurchase.items,
                    subtotal: currentPurchase.subtotal,
                    additionalFees: currentPurchase.additionalFees,
                    total: currentPurchase.total,
                    status: 'pending_verification',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    paymentVerified: false,
                    paymentVerifiedBy: null,
                    paymentVerifiedAt: null,
                    productDelivered: false,
                    deliveryDetails: '',
                    deliveryDate: null
                });
                
                // Notificar a los vendedores
                const sellerIds = [...new Set(currentPurchase.items.map(item => item.sellerId))];
                
                for (const sellerId of sellerIds) {
                    await db.collection('notifications').add({
                        userId: sellerId,
                        type: 'new_purchase',
                        message: `Tienes una nueva venta de ${user.displayName || user.email}. ¡Libera el producto para recibir tu pago!`,
                        purchaseId: purchaseRef.id,
                        read: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                showMessage("¡Pago confirmado! El vendedor será notificado y el administrador verificará tu pago.", "success", paymentMessage);
                
                // Limpiar carrito y resetear UI
                cart = [];
                updateCartUI();
                showSection('productsSection');
                
                // Cargar compras del usuario
                loadUserPurchases();
                
            } catch (error) {
                showMessage("Error al confirmar el pago: " + error.message, "error", paymentMessage);
            }
        });
        
        // Cancelar pago
        cancelPaymentBtn.addEventListener('click', () => {
            showSection('cartSection');
            showMessage("Compra cancelada", "error", paymentMessage);
        });
        
        // Cargar compras del usuario
        function loadUserPurchases() {
            const user = auth.currentUser;
            if (!user) return;
            
            purchasesList.innerHTML = '<p>Cargando tus compras...</p>';
            
            db.collection('purchases')
                .where('userId', '==', user.uid)
                .orderBy('createdAt', 'desc')
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        purchasesList.innerHTML = '<p>No tienes compras realizadas.</p>';
                        return;
                    }
                    
                    purchasesList.innerHTML = '';
                    
                    querySnapshot.forEach((doc) => {
                        const purchase = doc.data();
                        const purchaseElement = document.createElement('div');
                        purchaseElement.className = 'purchase-item';
                        
                        let statusClass = 'status-pending';
                        let statusText = 'Pendiente de verificación';
                        
                        if (purchase.paymentVerified) {
                            statusClass = 'status-approved';
                            statusText = 'Pago verificado';
                            
                            if (purchase.productDelivered) {
                                statusText = 'Producto entregado';
                            }
                        }
                        
                        // Determinar si se muestran las credenciales o mensaje de espera
                        let credentialsContent = '';
                        if (purchase.paymentVerified && purchase.productDelivered) {
                            credentialsContent = `
                                <div class="credentials-box">
                                    <h5>🔑 Acceso entregado por el vendedor:</h5>
                                    <p>${purchase.deliveryDetails}</p>
                                    <p><small>Entregado el: ${purchase.deliveryDate?.toDate().toLocaleString()}</small></p>
                                </div>
                            `;
                        } else if (purchase.paymentVerified) {
                            credentialsContent = `
                                <div class="credentials-box credentials-waiting">
                                    <h5>⏳ Esperando credenciales</h5>
                                    <p>El vendedor te enviará el acceso pronto.</p>
                                </div>
                            `;
                        }
                        
                        // CORRECCIÓN: Mostrar desglose de cargos
                        const feesBreakdown = purchase.additionalFees ? `
                            <div class="additional-fees">
                                <h5>Desglose de cargos:</h5>
                                <div class="fee-breakdown">
                                    <span>Subtotal:</span>
                                    <span>$${purchase.subtotal.toFixed(2)}</span>
                                </div>
                                <div class="fee-breakdown">
                                    <span>Impuestos y servicio de envío:</span>
                                    <span>$${purchase.additionalFees.toFixed(2)}</span>
                                </div>
                                <div class="fee-breakdown fee-total">
                                    <span>Total pagado:</span>
                                    <span>$${purchase.total.toFixed(2)}</span>
                                </div>
                            </div>
                        ` : '';
                        
                        purchaseElement.innerHTML = `
                            <h4>Compra #${doc.id.substring(0, 8)}</h4>
                            <p><strong>Fecha:</strong> ${purchase.createdAt?.toDate().toLocaleString()}</p>
                            <span class="purchase-status ${statusClass}">${statusText}</span>
                            
                            ${feesBreakdown}
                            
                            <h5>Productos:</h5>
                            <ul>
                                ${purchase.items.map(item => `<li>${item.name} - $${item.price.toFixed(2)} x ${item.quantity}</li>`).join('')}
                            </ul>
                            
                            ${credentialsContent}
                            
                            ${!purchase.paymentVerified ? `
                                <button class="admin-btn contact-admin-btn" data-purchase="${doc.id}">Consultar al Administrador</button>
                            ` : ''}
                        `;
                        
                        purchasesList.appendChild(purchaseElement);
                    });
                    
                    // Añadir event listeners a los botones de consulta
                    document.querySelectorAll('.contact-admin-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const purchaseId = e.target.getAttribute('data-purchase');
                            contactAdminAboutPayment(purchaseId);
                        });
                    });
                    
                })
                .catch((error) => {
                    purchasesList.innerHTML = '<p>Error al cargar tus compras.</p>';
                    console.error('Error:', error);
                });
        }
        
        // Cargar ventas del vendedor
        function loadSellerSales(searchTerm = '') {
            const user = auth.currentUser;
            if (!user || currentUserData.role !== 'seller') return;
            
            salesList.innerHTML = '<p>Cargando tus ventas...</p>';
            
            // Obtener todos los productos del vendedor
            db.collection('productos')
                .where('userId', '==', user.uid)
                .get()
                .then((productsSnapshot) => {
                    const productIds = productsSnapshot.docs.map(doc => doc.id);
                    
                    // Obtener todas las compras que contienen productos del vendedor
                    return db.collection('purchases')
                        .get()
                        .then((purchasesSnapshot) => {
                            const sales = [];
                            
                            purchasesSnapshot.forEach((doc) => {
                                const purchase = doc.data();
                                const sellerItems = purchase.items.filter(item => productIds.includes(item.id));
                                
                                if (sellerItems.length > 0) {
                                    // Filtrar por término de búsqueda si se proporciona
                                    if (!searchTerm || doc.id.includes(searchTerm)) {
                                        sales.push({
                                            id: doc.id,
                                            ...purchase,
                                            sellerItems: sellerItems,
                                            sellerTotal: sellerItems.reduce((sum, item) => sum + (item.price * item.quantity), 0)
                                        });
                                    }
                                }
                            });
                            
                            // Mostrar ventas
                            if (sales.length === 0) {
                                salesList.innerHTML = '<p>No tienes ventas realizadas.</p>';
                                return;
                            }
                            
                            salesList.innerHTML = '';
                            
                            sales.forEach(sale => {
                                const saleElement = document.createElement('div');
                                saleElement.className = 'purchase-item';
                                
                                let statusClass = 'status-pending';
                                let statusText = 'Pendiente de verificación';
                                
                                if (sale.paymentVerified) {
                                    statusClass = 'status-approved';
                                    statusText = 'Pago verificado';
                                    
                                    if (sale.productDelivered) {
                                        statusText = 'Producto entregado';
                                    }
                                }
                                
                                let deliverySection = '';
                                if (sale.paymentVerified) {
                                    if (sale.productDelivered) {
                                        deliverySection = `
                                            <div class="credentials-box">
                                                <h5>✅ Producto entregado</h5>
                                                <p><strong>Detalles enviados:</strong> ${sale.deliveryDetails}</p>
                                                <p><small>Fecha de entrega: ${sale.deliveryDate?.toDate().toLocaleString()}</small></p>
                                            </div>
                                        `;
                                    } else {
                                        deliverySection = `
                                            <div class="delivery-form-enhanced">
                                                <h4>📤 Enviar acceso al comprador</h4>
                                                <div class="delivery-details">
                                                    <p><strong>Comprador:</strong> ${sale.userName}</p>
                                                    <p><strong>Email:</strong> ${sale.userEmail}</p>
                                                    <p><strong>ID de Compra:</strong> ${sale.id.substring(0, 8)}</p>
                                                    <p><strong>Productos:</strong> ${sale.sellerItems.map(item => `${item.name} x${item.quantity}`).join(', ')}</p>
                                                    <p><strong>Total:</strong> $${sale.sellerTotal.toFixed(2)}</p>
                                                </div>
                                                <textarea id="deliveryDetails-${sale.id}" placeholder="Ingresa las credenciales, acceso o instrucciones para el comprador" rows="4"></textarea>
                                                <button class="admin-btn deliver-product-btn" data-purchase="${sale.id}">Enviar Acceso</button>
                                            </div>
                                        `;
                                    }
                                } else {
                                    deliverySection = `
                                        <div class="credentials-waiting">
                                            <p>⏳ Esperando verificación de pago por el administrador</p>
                                        </div>
                                    `;
                                }
                                
                                // CORRECCIÓN: Mostrar desglose de cargos
                                const feesBreakdown = sale.additionalFees ? `
                                    <div class="additional-fees">
                                        <h5>Desglose de cargos:</h5>
                                        <div class="fee-breakdown">
                                            <span>Subtotal:</span>
                                            <span>$${sale.subtotal.toFixed(2)}</span>
                                        </div>
                                        <div class="fee-breakdown">
                                            <span>Impuestos y servicio de envío:</span>
                                            <span>$${sale.additionalFees.toFixed(2)}</span>
                                        </div>
                                        <div class="fee-breakdown fee-total">
                                            <span>Total pagado:</span>
                                            <span>$${sale.total.toFixed(2)}</span>
                                        </div>
                                    </div>
                                ` : '';
                                
                                saleElement.innerHTML = `
                                    <h4>Venta #${sale.id.substring(0, 8)}</h4>
                                    <p><strong>Comprador:</strong> ${sale.userName}</p>
                                    <p><strong>Email:</strong> ${sale.userEmail}</p>
                                    <p><strong>Fecha:</strong> ${sale.createdAt?.toDate().toLocaleString()}</p>
                                    <span class="purchase-status ${statusClass}">${statusText}</span>
                                    
                                    ${feesBreakdown}
                                    
                                    <h5>Productos vendidos:</h5>
                                    <ul>
                                        ${sale.sellerItems.map(item => `<li>${item.name} - $${item.price.toFixed(2)} x ${item.quantity}</li>`).join('')}
                                    </ul>
                                    
                                    ${deliverySection}
                                `;
                                
                                salesList.appendChild(saleElement);
                            });
                            
                            // Añadir event listeners a los botones de entrega
                            document.querySelectorAll('.deliver-product-btn').forEach(btn => {
                                btn.addEventListener('click', (e) => {
                                    const purchaseId = e.target.getAttribute('data-purchase');
                                    const deliveryDetails = document.getElementById(`deliveryDetails-${purchaseId}`).value;
                                    
                                    if (!deliveryDetails) {
                                        showMessage("Por favor, ingresa los detalles de entrega", "error", paymentMessage);
                                        return;
                                    }
                                    
                                    deliverProduct(purchaseId, deliveryDetails);
                                });
                            });
                        });
                })
                .catch((error) => {
                    salesList.innerHTML = '<p>Error al cargar tus ventas.</p>';
                    console.error('Error:', error);
                });
        }
        
        // Entregar producto (enviar acceso)
        function deliverProduct(purchaseId, deliveryDetails) {
            db.collection('purchases').doc(purchaseId).update({
                productDelivered: true,
                deliveryDetails: deliveryDetails,
                deliveryDate: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                // Notificar al comprador
                return db.collection('purchases').doc(purchaseId).get()
                    .then((doc) => {
                        const purchase = doc.data();
                        return db.collection('notifications').add({
                            userId: purchase.userId,
                            type: 'product_delivered',
                            message: `El vendedor ha enviado el acceso para tu compra ${purchaseId.substring(0, 8)}`,
                            purchaseId: purchaseId,
                            read: false,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });
            })
            .then(() => {
                showMessage("¡Acceso enviado al comprador!", "success", paymentMessage);
                loadSellerSales(); // Recargar la lista de ventas
            })
            .catch((error) => {
                showMessage("Error al enviar el acceso: " + error.message, "error", paymentMessage);
            });
        }
        
        // Contactar al administrador sobre un pago
        function contactAdminAboutPayment(purchaseId) {
            db.collection('adminNotifications').add({
                type: 'payment_inquiry',
                purchaseId: purchaseId,
                message: `El usuario ${auth.currentUser.email} tiene una consulta sobre el pago de la compra ${purchaseId}`,
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                showMessage("Consulta enviada al administrador", "success", paymentMessage);
            })
            .catch((error) => {
                showMessage("Error al enviar la consulta: " + error.message, "error", paymentMessage);
            });
        }
        
        // Cargar datos del usuario
        function loadUserData(userId) {
            db.collection('users').doc(userId).get()
                .then((doc) => {
                    if (doc.exists) {
                        currentUserData = doc.data();
                        userName.textContent = currentUserData.name || currentUserData.email;
                        userEmail.textContent = currentUserData.email;
                        userRole.textContent = currentUserData.role === 'seller' ? 'Vendedor Verificado' : 'Comprador';
                        
                        // Actualizar información en el menú móvil
                        updateMobileUserInfo();
                        
                        // Mostrar sección de verificación si no es vendedor
                        if (currentUserData.role !== 'seller') {
                            sellerVerificationSection.style.display = 'block';
                            
                            // Mostrar estado de verificación
                            const verificationStatus = currentUserData.sellerVerification?.status || 'not_requested';
                            
                            if (verificationStatus === 'not_requested') {
                                sellerStatus.innerHTML = '';
                                showVerificationFormBtn.style.display = 'block';
                                showVerificationFormBtn.textContent = 'Convertirme en vendedor';
                            } else if (verificationStatus === 'pending') {
                                sellerStatus.textContent = 'Estado: Pendiente de revisión';
                                sellerStatus.className = 'verification-status status-pending';
                                showVerificationFormBtn.style.display = 'none';
                            } else if (verificationStatus === 'approved') {
                                sellerStatus.textContent = 'Estado: ¡Verificación aprobada!';
                                sellerStatus.className = 'verification-status status-approved';
                                showVerificationFormBtn.style.display = 'none';
                            } else if (verificationStatus === 'rejected') {
                                sellerStatus.textContent = 'Estado: Solicitud rechazada. Contacta con soporte.';
                                sellerStatus.className = 'verification-status status-rejected';
                                showVerificationFormBtn.style.display = 'none';
                            }
                        } else {
                            sellerVerificationSection.style.display = 'none';
                        }
                        
                        // Mostrar botón de publicar producto solo para vendedores
                        if (currentUserData.role === 'seller') {
                            showPublishFormBtn.style.display = 'block';
                        } else {
                            showPublishFormBtn.style.display = 'none';
                            publishForm.style.display = 'none';
                        }
                        
                        // Actualizar visibilidad del menú
                        updateMenuVisibility();
                        
                        // Cargar notificaciones y mensajes de soporte
                        loadNotifications();
                        listenForSupportMessages();
                    }
                })
                .catch((error) => {
                    console.error("Error al cargar datos del usuario:", error);
                });
        }
        
        // Cargar solicitudes de verificación para el admin
        function loadVerificationRequests() {
            if (!isAdmin) return;
            
            verificationsList.innerHTML = '<p>Cargando solicitudes...</p>';
            
            db.collection('sellerVerifications')
                .where('status', '==', 'pending')
                .orderBy('createdAt', 'desc')
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        verificationsList.innerHTML = '<p>No hay solicitudes pendientes.</p>';
                        return;
                    }
                    
                    verificationsList.innerHTML = '';
                    
                    querySnapshot.forEach((doc) => {
                        const verification = doc.data();
                        const verificationElement = document.createElement('div');
                        verificationElement.className = 'verification-item';
                        verificationElement.innerHTML = `
                            <h4>Solicitud de: ${verification.userName}</h4>
                            <p><strong>Email:</strong> ${verification.userEmail}</p>
                            <p><strong>Nombre completo:</strong> ${verification.fullName}</p>
                            <p><strong>País:</strong> ${verification.country}</p>
                            <p><strong>Identificación:</strong> ${verification.idNumber}</p>
                            <p><strong>ID de Binance:</strong> ${verification.binanceId}</p>
                            <p><strong>Negocio:</strong> ${verification.businessName || 'No especificado'}</p>
                            <p><strong>Descripción:</strong> ${verification.businessDescription || 'No especificada'}</p>
                            <p><strong>Teléfono:</strong> ${verification.phoneNumber}</p>
                            <p><strong>Fecha de solicitud:</strong> ${verification.createdAt?.toDate().toLocaleString()}</p>
                            
                            <div class="verification-images">
                                <div>
                                    <p><strong>Foto de documento:</strong></p>
                                    <img src="${verification.idPhoto}" alt="Foto de documento">
                                </div>
                                <div>
                                    <p><strong>Selfie con documento:</strong></p>
                                    <img src="${verification.selfiePhoto}" alt="Selfie con documento">
                                </div>
                            </div>
                            
                            <div class="admin-actions">
                                <button class="admin-btn approve-btn" data-id="${doc.id}" data-userid="${verification.userId}">Aprobar</button>
                                <button class="admin-btn reject-btn" data-id="${doc.id}" data-userid="${verification.userId}">Rechazar</button>
                            </div>
                        `;
                        verificationsList.appendChild(verificationElement);
                    });
                    
                    // Añadir event listeners a los botones
                    document.querySelectorAll('.approve-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const verificationId = e.target.getAttribute('data-id');
                            const userId = e.target.getAttribute('data-userid');
                            approveVerification(verificationId, userId);
                        });
                    });
                    
                    document.querySelectorAll('.reject-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const verificationId = e.target.getAttribute('data-id');
                            const userId = e.target.getAttribute('data-userid');
                            rejectVerification(verificationId, userId);
                        });
                    });
                })
                .catch((error) => {
                    verificationsList.innerHTML = '<p>Error al cargar las solicitudes.</p>';
                    console.error('Error:', error);
                });
        }
        
        // Cargar pagos pendientes para el admin
        function loadPendingPayments() {
            if (!isAdmin) return;
            
            paymentsList.innerHTML = '<p>Cargando pagos...</p>';
            
            db.collection('purchases')
                .where('paymentVerified', '==', false)
                .orderBy('createdAt', 'desc')
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        paymentsList.innerHTML = '<p>No hay pagos pendientes de verificación.</p>';
                        return;
                    }
                    
                    paymentsList.innerHTML = '';
                    
                    querySnapshot.forEach((doc) => {
                        const purchase = doc.data();
                        const purchaseElement = document.createElement('div');
                        purchaseElement.className = 'purchase-item';
                        
                        // Obtener información del vendedor para mostrar su ID de Binance
                        const sellerIds = [...new Set(purchase.items.map(item => item.sellerId))];
                        let sellerInfo = '';
                        
                        // Para cada vendedor, obtener su información
                        Promise.all(sellerIds.map(sellerId => 
                            db.collection('users').doc(sellerId).get()
                        )).then(sellerDocs => {
                            sellerDocs.forEach((sellerDoc, index) => {
                                if (sellerDoc.exists) {
                                    const sellerData = sellerDoc.data();
                                    // Obtener ID de Binance del vendedor desde sus verificaciones
                                    db.collection('sellerVerifications')
                                        .where('userId', '==', sellerIds[index])
                                        .where('status', '==', 'approved')
                                        .get()
                                        .then(verifications => {
                                            if (!verifications.empty) {
                                                const verification = verifications.docs[0].data();
                                                sellerInfo += `
                                                    <div class="seller-binance-id">
                                                        <strong>Vendedor:</strong> ${sellerData.name || sellerData.email}<br>
                                                        <strong>ID de Binance:</strong> ${verification.binanceId}<br>
                                                        <strong>Total a enviar:</strong> $${purchase.items
                                                            .filter(item => item.sellerId === sellerIds[index])
                                                            .reduce((sum, item) => sum + (item.price * item.quantity), 0)
                                                            .toFixed(2)}
                                                    </div>
                                                `;
                                                
                                                // Actualizar el contenido con la información del vendedor
                                                purchaseElement.querySelector('.seller-info-container').innerHTML = sellerInfo;
                                            }
                                        });
                                }
                            });
                        });
                        
                        // NUEVO: Botón para adjuntar comprobante de pago
                        const proofButton = `
                            <div style="margin-top: 10px;">
                                <input type="file" id="proofImage-${doc.id}" accept="image/*" style="display: none;">
                                <button class="proof-btn" onclick="document.getElementById('proofImage-${doc.id}').click()">Adjuntar Comprobante</button>
                                <div id="proofPreview-${doc.id}"></div>
                            </div>
                        `;
                        
                        purchaseElement.innerHTML = `
                            <h4>Compra de: ${purchase.userName}</h4>
                            <p><strong>ID de compra:</strong> ${doc.id}</p>
                            <p><strong>Fecha:</strong> ${purchase.createdAt?.toDate().toLocaleString()}</p>
                            <p><strong>Total:</strong> $${purchase.total.toFixed(2)}</p>
                            
                            <h5>Productos:</h5>
                            <ul>
                                ${purchase.items.map(item => `<li>${item.name} - $${item.price.toFixed(2)} x ${item.quantity} (Vendedor: ${item.sellerName})</li>`).join('')}
                            </ul>
                            
                            <div class="seller-info-container">
                                <p>Cargando información del vendedor...</p>
                            </div>
                            
                            ${proofButton}
                            
                            <div class="admin-actions">
                                <button class="admin-btn approve-btn" data-purchase="${doc.id}">Verificar Pago</button>
                                <button class="admin-btn reject-btn" data-purchase="${doc.id}">Rechazar Pago</button>
                            </div>
                        `;
                        paymentsList.appendChild(purchaseElement);
                        
                        // Event listener para el input de comprobante
                        document.getElementById(`proofImage-${doc.id}`).addEventListener('change', function(e) {
                            const file = e.target.files[0];
                            if (file) {
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    const proofPreview = document.getElementById(`proofPreview-${doc.id}`);
                                    proofPreview.innerHTML = `<img src="${e.target.result}" class="proof-image" alt="Comprobante de pago">`;
                                }
                                reader.readAsDataURL(file);
                            }
                        });
                    });
                    
                    // Añadir event listeners a los botones
                    document.querySelectorAll('.approve-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const purchaseId = e.target.getAttribute('data-purchase');
                            const proofImage = document.getElementById(`proofImage-${purchaseId}`).files[0];
                            verifyPayment(purchaseId, true, proofImage);
                        });
                    });
                    
                    document.querySelectorAll('.reject-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const purchaseId = e.target.getAttribute('data-purchase');
                            verifyPayment(purchaseId, false);
                        });
                    });
                })
                .catch((error) => {
                    paymentsList.innerHTML = '<p>Error al cargar los pagos.</p>';
                    console.error('Error:', error);
                });
        }
        
        // NUEVO: Cargar historial de transacciones
        function loadTransactionHistory() {
            if (!isAdmin) return;
            
            transactionHistory.innerHTML = '<p>Cargando historial de transacciones...</p>';
            
            db.collection('purchases')
                .orderBy('createdAt', 'desc')
                .limit(50)
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        transactionHistory.innerHTML = '<p>No hay transacciones en el historial.</p>';
                        return;
                    }
                    
                    transactionHistory.innerHTML = '';
                    
                    querySnapshot.forEach((doc) => {
                        const purchase = doc.data();
                        const transactionElement = document.createElement('div');
                        transactionElement.className = 'transaction-item';
                        
                        // Obtener información de los vendedores
                        const sellerIds = [...new Set(purchase.items.map(item => item.sellerId))];
                        
                        Promise.all(sellerIds.map(sellerId => 
                            db.collection('users').doc(sellerId).get()
                        )).then(sellerDocs => {
                            let sellerInfo = '';
                            sellerDocs.forEach((sellerDoc, index) => {
                                if (sellerDoc.exists) {
                                    const sellerData = sellerDoc.data();
                                    sellerInfo += `
                                        <div class="transaction-seller">
                                            <h4>Vendedor ${index + 1}</h4>
                                            <p><strong>Nombre:</strong> ${sellerData.name || sellerData.email}</p>
                                            <p><strong>Email:</strong> ${sellerData.email}</p>
                                            <p><strong>Productos:</strong> ${purchase.items
                                                .filter(item => item.sellerId === sellerIds[index])
                                                .map(item => `${item.name} x${item.quantity}`).join(', ')}</p>
                                            <p><strong>Total:</strong> $${purchase.items
                                                .filter(item => item.sellerId === sellerIds[index])
                                                .reduce((sum, item) => sum + (item.price * item.quantity), 0)
                                                .toFixed(2)}</p>
                                        </div>
                                    `;
                                }
                            });
                            
                            transactionElement.innerHTML = `
                                <div class="transaction-header">
                                    <span class="transaction-id">Transacción: ${doc.id.substring(0, 8)}</span>
                                    <span class="transaction-date">${purchase.createdAt?.toDate().toLocaleString()}</span>
                                </div>
                                <div class="transaction-details">
                                    <div class="transaction-buyer">
                                        <h4>Comprador</h4>
                                        <p><strong>Nombre:</strong> ${purchase.userName}</p>
                                        <p><strong>Email:</strong> ${purchase.userEmail}</p>
                                        <p><strong>Estado:</strong> ${purchase.paymentVerified ? 'Pago verificado' : 'Pendiente'}</p>
                                        <p><strong>Entrega:</strong> ${purchase.productDelivered ? 'Entregado' : 'Pendiente'}</p>
                                    </div>
                                    ${sellerInfo}
                                </div>
                            `;
                        });
                        
                        transactionHistory.appendChild(transactionElement);
                    });
                })
                .catch((error) => {
                    transactionHistory.innerHTML = '<p>Error al cargar el historial de transacciones.</p>';
                    console.error('Error:', error);
                });
        }
        
        // Cargar vendedores verificados para el admin
        function loadVerifiedSellers() {
            if (!isAdmin) return;
            
            verifiedSellersList.innerHTML = '<p>Cargando vendedores verificados...</p>';
            
            db.collection('users')
                .where('role', '==', 'seller')
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        verifiedSellersList.innerHTML = '<p>No hay vendedores verificados.</p>';
                        return;
                    }
                    
                    verifiedSellersList.innerHTML = '';
                    
                    querySnapshot.forEach((doc) => {
                        const seller = doc.data();
                        const sellerElement = document.createElement('div');
                        sellerElement.className = 'verification-item';
                        sellerElement.innerHTML = `
                            <h4>Vendedor: ${seller.name}</h4>
                            <p><strong>Email:</strong> ${seller.email}</p>
                            <p><strong>Fecha de registro:</strong> ${seller.createdAt?.toDate().toLocaleString()}</p>
                            
                            <div class="admin-actions">
                                <button class="admin-btn" data-userid="${doc.id}" onclick="contactSeller('${doc.id}', '${seller.email}')">Contactar</button>
                                <button class="admin-btn" data-userid="${doc.id}" onclick="limitAccount('${doc.id}', '1')">Limitar 1 hora</button>
                                <button class="admin-btn" data-userid="${doc.id}" onclick="limitAccount('${doc.id}', '24')">Limitar 24 horas</button>
                                <button class="admin-btn reject-btn" data-userid="${doc.id}" onclick="deleteAccount('${doc.id}')">Eliminar Cuenta</button>
                            </div>
                        `;
                        verifiedSellersList.appendChild(sellerElement);
                    });
                })
                .catch((error) => {
                    verifiedSellersList.innerHTML = '<p>Error al cargar los vendedores.</p>';
                    console.error('Error:', error);
                });
        }
        
        // NUEVO: Cargar lista de vendedores para el chat
        function loadSellersForChat() {
            if (!isAdmin) return;
            
            sellersList.innerHTML = '<p>Cargando vendedores...</p>';
            
            db.collection('users')
                .where('role', '==', 'seller')
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        sellersList.innerHTML = '<p>No hay vendedores registrados.</p>';
                        return;
                    }
                    
                    sellersList.innerHTML = '';
                    
                    querySnapshot.forEach((doc) => {
                        const seller = doc.data();
                        const sellerItem = document.createElement('div');
                        sellerItem.className = 'seller-item';
                        sellerItem.setAttribute('data-seller-id', doc.id);
                        sellerItem.innerHTML = `
                            <strong>${seller.name}</strong>
                            <br>
                            <small>${seller.email}</small>
                        `;
                        
                        sellerItem.addEventListener('click', () => {
                            // Remover clase activa de todos los elementos
                            document.querySelectorAll('.seller-item').forEach(item => {
                                item.classList.remove('active');
                            });
                            
                            // Agregar clase activa al elemento seleccionado
                            sellerItem.classList.add('active');
                            
                            // Mostrar chat con el vendedor seleccionado
                            selectedSellerId = doc.id;
                            selectedSellerName.textContent = seller.name;
                            sellerChatContainer.style.display = 'block';
                            
                            // Cargar mensajes del chat
                            loadSellerChatMessages(doc.id);
                        });
                        
                        sellersList.appendChild(sellerItem);
                    });
                })
                .catch((error) => {
                    sellersList.innerHTML = '<p>Error al cargar los vendedores.</p>';
                    console.error('Error:', error);
                });
        }
        
        // NUEVO: Cargar mensajes del chat con un vendedor específico
        function loadSellerChatMessages(sellerId) {
            if (!isAdmin) return;
            
            sellerChatMessages.innerHTML = '<p>Cargando mensajes...</p>';
            
            db.collection('adminSellerChat')
                .where('sellerId', '==', sellerId)
                .orderBy('timestamp', 'asc')
                .get()
                .then((querySnapshot) => {
                    sellerChatMessages.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        sellerChatMessages.innerHTML = '<p>No hay mensajes aún.</p>';
                        return;
                    }
                    
                    querySnapshot.forEach((doc) => {
                        const message = doc.data();
                        const messageElement = document.createElement('div');
                        messageElement.className = `message ${message.sender === 'admin' ? 'message-sent' : 'message-received'}`;
                        messageElement.textContent = `${message.senderName}: ${message.text}`;
                        sellerChatMessages.appendChild(messageElement);
                    });
                    
                    sellerChatMessages.scrollTop = sellerChatMessages.scrollHeight;
                })
                .catch((error) => {
                    sellerChatMessages.innerHTML = '<p>Error al cargar los mensajes.</p>';
                    console.error('Error:', error);
                });
        }
        
        // NUEVO: Enviar mensaje a un vendedor
        function sendMessageToSeller() {
            if (!isAdmin || !selectedSellerId) return;
            
            const messageText = sellerChatInput.value.trim();
            if (!messageText) return;
            
            const user = auth.currentUser;
            
            // Agregar mensaje a la interfaz
            const messageElement = document.createElement('div');
            messageElement.className = 'message message-sent';
            messageElement.textContent = `Admin: ${messageText}`;
            sellerChatMessages.appendChild(messageElement);
            
            // Limpiar input
            sellerChatInput.value = '';
            
            // Desplazar hacia abajo
            sellerChatMessages.scrollTop = sellerChatMessages.scrollHeight;
            
            // Guardar mensaje en la base de datos
            db.collection('adminSellerChat').add({
                sellerId: selectedSellerId,
                text: messageText,
                sender: 'admin',
                senderName: user.displayName || user.email,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                // Notificar al vendedor
                return db.collection('notifications').add({
                    userId: selectedSellerId,
                    type: 'admin_message',
                    message: `Tienes un nuevo mensaje del administrador`,
                    read: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    from: 'Administrador'
                });
            })
            .catch((error) => {
                console.error('Error al enviar mensaje:', error);
            });
        }
        
        // Contactar vendedor (función para el admin)
        function contactSeller(userId, userEmail) {
            const message = prompt(`Escribe el mensaje para ${userEmail}:`);
            if (message) {
                db.collection('notifications').add({
                    userId: userId,
                    type: 'admin_message',
                    message: message,
                    read: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    from: 'Administrador'
                })
                .then(() => {
                    showAdminNotification("Mensaje enviado al vendedor", "success");
                })
                .catch((error) => {
                    showAdminNotification("Error al enviar el mensaje: " + error.message, "error");
                });
            }
        }
        
        // Limitar cuenta (función para el admin)
        function limitAccount(userId, hours) {
            const limitUntil = new Date();
            limitUntil.setHours(limitUntil.getHours() + parseInt(hours));
            
            db.collection('users').doc(userId).update({
                limitedUntil: limitUntil
            })
            .then(() => {
                // Ocultar productos del vendedor limitado
                hideSellerProducts(userId);
                showAdminNotification(`Cuenta limitada por ${hours} horas`, "success");
                
                // Programar reactivación automática
                setTimeout(() => {
                    db.collection('users').doc(userId).update({
                        limitedUntil: null
                    })
                    .then(() => {
                        showAdminNotification(`Cuenta de usuario reactivada automáticamente`, "success");
                        loadVerifiedSellers();
                    });
                }, parseInt(hours) * 60 * 60 * 1000);
            })
            .catch((error) => {
                showAdminNotification("Error al limitar la cuenta: " + error.message, "error");
            });
        }
        
        // Ocultar productos de un vendedor limitado
        function hideSellerProducts(userId) {
            db.collection('productos')
                .where('userId', '==', userId)
                .get()
                .then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        doc.ref.update({
                            status: 'hidden'
                        });
                    });
                })
                .then(() => {
                    loadProducts();
                });
        }
        
        // Eliminar cuenta (función para el admin)
        function deleteAccount(userId) {
            if (confirm("¿Estás seguro de que deseas eliminar esta cuenta? Esta acción no se puede deshacer.")) {
                // Primero eliminar todos los productos del vendedor
                db.collection('productos')
                    .where('userId', '==', userId)
                    .get()
                    .then((querySnapshot) => {
                        const batch = db.batch();
                        querySnapshot.forEach((doc) => {
                            batch.delete(doc.ref);
                        });
                        return batch.commit();
                    })
                    .then(() => {
                        // Luego eliminar la cuenta de usuario
                        return db.collection('users').doc(userId).delete();
                    })
                    .then(() => {
                        showAdminNotification("Cuenta eliminada correctamente", "success");
                        loadVerifiedSellers();
                        loadProducts();
                    })
                    .catch((error) => {
                        showAdminNotification("Error al eliminar la cuenta: " + error.message, "error");
                    });
            }
        }
        
        // Aprobar verificación
        function approveVerification(verificationId, userId) {
            const user = auth.currentUser;
            
            db.collection('sellerVerifications').doc(verificationId).update({
                status: 'approved',
                reviewedAt: firebase.firestore.FieldValue.serverTimestamp(),
                reviewedBy: user.email
            })
            .then(() => {
                // Actualizar el rol del usuario a vendedor
                return db.collection('users').doc(userId).update({
                    role: 'seller',
                    'sellerVerification.status': 'approved',
                    'sellerVerification.reviewedAt': firebase.firestore.FieldValue.serverTimestamp()
                });
            })
            .then(() => {
                showAdminNotification("Solicitud aprobada correctamente", "success");
                loadVerificationRequests();
                loadVerifiedSellers();
                loadSellersForChat(); // Actualizar lista de vendedores para el chat
            })
            .catch((error) => {
                showAdminNotification("Error al aprobar la solicitud: " + error.message, "error");
            });
        }
        
        // Rechazar verificación
        function rejectVerification(verificationId, userId) {
            const user = auth.currentUser;
            
            db.collection('sellerVerifications').doc(verificationId).update({
                status: 'rejected',
                reviewedAt: firebase.firestore.FieldValue.serverTimestamp(),
                reviewedBy: user.email
            })
            .then(() => {
                // Actualizar el estado de verificación del usuario
                return db.collection('users').doc(userId).update({
                    'sellerVerification.status': 'rejected',
                    'sellerVerification.reviewedAt': firebase.firestore.FieldValue.serverTimestamp()
                });
            })
            .then(() => {
                showAdminNotification("Solicitud rechazada correctamente", "success");
                loadVerificationRequests();
            })
            .catch((error) => {
                showAdminNotification("Error al rechazar la solicitud: " + error.message, "error");
            });
        }
        
        // Verificar pago
        function verifyPayment(purchaseId, approved, proofImage = null) {
            const user = auth.currentUser;
            
            db.collection('purchases').doc(purchaseId).update({
                paymentVerified: approved,
                paymentVerifiedBy: user.email,
                paymentVerifiedAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                if (approved) {
                    showAdminNotification("Pago verificado correctamente", "success");
                    
                    // Notificar al comprador
                    return db.collection('purchases').doc(purchaseId).get()
                    .then((doc) => {
                        const purchase = doc.data();
                        
                        // Si hay comprobante, guardarlo
                        if (proofImage) {
                            const reader = new FileReader();
                            reader.readAsDataURL(proofImage);
                            reader.onload = () => {
                                db.collection('paymentProofs').add({
                                    purchaseId: purchaseId,
                                    proofImage: reader.result,
                                    uploadedBy: user.email,
                                    uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            };
                        }
                        
                        return db.collection('notifications').add({
                            userId: purchase.userId,
                            type: 'payment_verified',
                            message: `Tu pago para la compra ${purchaseId} ha sido verificado. El vendedor te enviará el producto pronto.`,
                            purchaseId: purchaseId,
                            read: false,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });
                } else {
                    showAdminNotification("Pago rechazado", 'success');
                }
            })
            .then(() => {
                loadPendingPayments();
                loadTransactionHistory();
            })
            .catch((error) => {
                showAdminNotification("Error al verificar el pago: " + error.message, "error");
            });
        }
        
        // Cargar productos
        function loadProducts() {
            productsList.innerHTML = '';
            
            let productsQuery = db.collection('productos')
                .where('status', '==', 'active');
            
            // Si hay una categoría seleccionada, filtrar por ella
            if (selectedCategory) {
                productsQuery = productsQuery.where('category', '==', selectedCategory);
            }
            
            productsQuery.orderBy('createdAt', 'desc')
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        productsList.innerHTML = '<p>No hay productos disponibles.</p>';
                        return;
                    }
                    
                    querySnapshot.forEach((doc) => {
                        const product = doc.data();
                        
                        // Filtrar por término de búsqueda si se proporciona
                        if (searchTerm && !product.name.toLowerCase().includes(searchTerm.toLowerCase()) && 
                            !product.description.toLowerCase().includes(searchTerm.toLowerCase())) {
                            return;
                        }
                        
                        const productElement = document.createElement('div');
                        productElement.className = 'product-card';
                        
                        // Mostrar imagen del producto si existe
                        const productImageHTML = product.image 
                            ? `<img src="${product.image}" alt="${product.name}" class="product-image">`
                            : `<div class="product-image">Imagen del producto</div>`;
                        
                        // Mostrar información de garantía
                        const warrantyHTML = product.warranty 
                            ? `<div class="warranty-info">Garantía: <span class="warranty-badge">${product.warranty}</span></div>`
                            : '';
                        
                        productElement.innerHTML = `
                            ${productImageHTML}
                            <div class="product-title">${product.name}</div>
                            <div class="product-price">$${product.price.toFixed(2)}</div>
                            <div class="product-category">${product.category}</div>
                            ${warrantyHTML}
                            <div class="product-description">${product.description}</div>
                            <div class="product-seller">Vendedor: ${product.userName}</div>
                            
                            <div class="product-actions-grid">
                                <button class="buy-btn-grid" data-id="${doc.id}" data-product='${JSON.stringify(product)}'>Comprar</button>
                                <button class="cart-btn-grid" data-id="${doc.id}" data-product='${JSON.stringify(product)}'>Carrito</button>
                            </div>
                        `;
                        productsList.appendChild(productElement);
                    });
                    
                    // Añadir event listeners a los botones
                    document.querySelectorAll('.buy-btn-grid').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const product = JSON.parse(e.target.getAttribute('data-product'));
                            // Para compra inmediata, agregar al carrito y proceder al pago
                            cart = [{
                                id: e.target.getAttribute('data-id'),
                                name: product.name,
                                price: product.price,
                                quantity: 1,
                                sellerId: product.userId,
                                sellerName: product.userName
                            }];
                            updateCartUI();
                            checkoutBtn.click();
                        });
                    });
                    
                    document.querySelectorAll('.cart-btn-grid').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const product = JSON.parse(e.target.getAttribute('data-product'));
                            addToCart(product);
                        });
                    });
                    
                    // Iniciar observación de elementos para animación
                    setTimeout(observeElements, 100);
                })
                .catch((error) => {
                    productsList.innerHTML = '<p>Error al cargar los productos.</p>';
                    console.error('Error:', error);
                });
        }
        
        // NUEVO: Cargar mensajes de soporte
        function loadSupportMessages() {
            const user = auth.currentUser;
            if (!user) return;
            
            chatMessages.innerHTML = '<p>Cargando mensajes...</p>';
            
            db.collection('supportMessages')
                .where('userId', '==', user.uid)
                .orderBy('timestamp', 'asc')
                .get()
                .then((querySnapshot) => {
                    chatMessages.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        chatMessages.innerHTML = '<p>No hay mensajes aún. ¡Inicia la conversación!</p>';
                        return;
                    }
                    
                    querySnapshot.forEach((doc) => {
                        const message = doc.data();
                        const messageElement = document.createElement('div');
                        messageElement.className = `message ${message.sender === 'user' ? 'message-sent' : 'message-received'}`;
                        messageElement.textContent = message.text;
                        chatMessages.appendChild(messageElement);
                    });
                    
                    // Desplazar hacia abajo para mostrar el último mensaje
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                })
                .catch((error) => {
                    chatMessages.innerHTML = '<p>Error al cargar los mensajes.</p>';
                    console.error('Error:', error);
                });
        }
        
        // NUEVO: Enviar mensaje de soporte
        function sendSupportMessage() {
            const user = auth.currentUser;
            if (!user) return;
            
            const messageText = chatInput.value.trim();
            if (!messageText) return;
            
            // Agregar mensaje a la interfaz
            const messageElement = document.createElement('div');
            messageElement.className = 'message message-sent';
            messageElement.textContent = messageText;
            chatMessages.appendChild(messageElement);
            
            // Limpiar input
            chatInput.value = '';
            
            // Desplazar hacia abajo
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Guardar mensaje en la base de datos
            db.collection('supportMessages').add({
                userId: user.uid,
                userName: user.displayName || user.email,
                text: messageText,
                sender: 'user',
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                read: false
            })
            .then(() => {
                // NUEVO: Notificar al administrador sobre el mensaje de soporte
                if (isAdmin) return; // No notificar si el que envía es el admin
                
                // Buscar al administrador (thecam35@gmail.com)
                return db.collection('users')
                    .where('email', '==', 'thecam35@gmail.com')
                    .get()
                    .then((adminSnapshot) => {
                        if (!adminSnapshot.empty) {
                            const adminId = adminSnapshot.docs[0].id;
                            return db.collection('notifications').add({
                                userId: adminId,
                                type: 'support_message',
                                message: `Nuevo mensaje de soporte de ${user.displayName || user.email}`,
                                read: false,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                fromUser: user.uid
                            });
                        }
                    });
            })
            .catch((error) => {
                console.error('Error al enviar mensaje:', error);
            });
        }
        
        // NUEVO: Escuchar nuevos mensajes de soporte
        function listenForSupportMessages() {
            const user = auth.currentUser;
            if (!user) return;
            
            db.collection('supportMessages')
                .where('userId', '==', user.uid)
                .where('sender', '==', 'admin')
                .where('read', '==', false)
                .onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const message = change.doc.data();
                            
                            // Marcar como leído
                            db.collection('supportMessages').doc(change.doc.id).update({
                                read: true
                            });
                            
                            // Mostrar notificación si el chat no está abierto
                            if (!supportChatOpen) {
                                unreadMessages++;
                                chatBadge.textContent = unreadMessages;
                                chatBadge.style.display = 'block';
                            }
                            
                            // Agregar mensaje a la interfaz si el chat está abierto
                            if (supportChatOpen) {
                                const messageElement = document.createElement('div');
                                messageElement.className = 'message message-received';
                                messageElement.textContent = message.text;
                                chatMessages.appendChild(messageElement);
                                chatMessages.scrollTop = chatMessages.scrollHeight;
                            }
                        }
                    });
                });
        }
        
        // NUEVO: Cargar notificaciones
        function loadNotifications() {
            const user = auth.currentUser;
            if (!user) return;
            
            notificationsList.innerHTML = '<p>Cargando notificaciones...</p>';
            
            db.collection('notifications')
                .where('userId', '==', user.uid)
                .orderBy('createdAt', 'desc')
                .get()
                .then((querySnapshot) => {
                    notificationsList.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        notificationsList.innerHTML = '<p>No tienes notificaciones.</p>';
                        return;
                    }
                    
                    querySnapshot.forEach((doc) => {
                        const notification = doc.data();
                        const notificationElement = document.createElement('div');
                        notificationElement.className = `notification-item ${notification.read ? '' : 'unread'}`;
                        notificationElement.innerHTML = `
                            <div>${notification.message}</div>
                            <div class="notification-time">${notification.createdAt?.toDate().toLocaleString()}</div>
                        `;
                        
                        notificationElement.addEventListener('click', () => {
                            // Marcar como leída
                            db.collection('notifications').doc(doc.id).update({
                                read: true
                            });
                            
                            // Redirigir según el tipo de notificación
                            if (notification.type === 'new_purchase') {
                                showSection('sellerSales');
                                loadSellerSales();
                            } else if (notification.type === 'product_delivered') {
                                showSection('myPurchases');
                                loadUserPurchases();
                            } else if (notification.type === 'support_message' && isAdmin) {
                                // Si es admin y es un mensaje de soporte, abrir el chat de soporte
                                chatSupport.style.display = 'flex';
                                supportChatOpen = true;
                                unreadMessages = 0;
                                chatBadge.style.display = 'none';
                                loadSupportMessages();
                            }
                            
                            notificationsPanel.style.display = 'none';
                        });
                        
                        notificationsList.appendChild(notificationElement);
                    });
                })
                .catch((error) => {
                    notificationsList.innerHTML = '<p>Error al cargar las notificaciones.</p>';
                    console.error('Error:', error);
                });
        }
        
        // NUEVO: Escuchar nuevas notificaciones
        function listenForNotifications() {
            const user = auth.currentUser;
            if (!user) return;
            
            db.collection('notifications')
                .where('userId', '==', user.uid)
                .where('read', '==', false)
                .onSnapshot((snapshot) => {
                    unreadNotifications = snapshot.size;
                    
                    if (unreadNotifications > 0) {
                        navNotificationsCount.textContent = unreadNotifications;
                        navNotificationsCount.style.display = 'block';
                    } else {
                        navNotificationsCount.style.display = 'none';
                    }
                });
        }
        
        // Mostrar una sección específica
        function showSection(sectionId) {
            // Ocultar todas las secciones
            sections.forEach(section => {
                section.classList.remove('active');
            });
            
            // Ocultar también la sección de información de usuario
            userInfo.classList.remove('active');
            
            // Ocultar formulario móvil
            mobileVerificationContainer.style.display = 'none';
            
            // Mostrar la sección seleccionada
            document.getElementById(sectionId).classList.add('active');
        }
        
        // Mostrar/ocultar formularios
        document.getElementById('showPublishForm').addEventListener('click', () => {
            publishForm.style.display = publishForm.style.display === 'none' ? 'block' : 'none';
        });
        
        document.getElementById('refreshVerifications').addEventListener('click', () => {
            loadVerificationRequests();
            loadPendingPayments();
            loadVerifiedSellers();
            loadTransactionHistory();
            loadSellersForChat(); // Actualizar lista de vendedores para el chat
        });
        
        // Traducir códigos de error
        function getErrorMessage(errorCode) {
            const errors = {
                'auth/email-already-in-use': 'Este correo electrónico ya está en uso.',
                'auth/invalid-email': 'El correo electrónico no es válido.',
                'auth/operation-not-allowed': 'Operación no permitida.',
                'auth/weak-password': 'La contraseña es demasiado débil.',
                'auth/user-disabled': 'Esta cuenta ha sido deshabilitada.',
                'auth/user-not-found': 'No existe una cuenta con este correo electrónico.',
                'auth/wrong-password': 'Contraseña incorrecta.',
                'permission-denied': 'Permisos insuficientes.'
            };
            
            return errors[errorCode] || 'Ocurrió un error inesperado.';
        }
        
        // Observador de autenticación
        auth.onAuthStateChanged((user) => {
            if (user) {
                // Usuario ha iniciado sesión
                authSection.classList.remove('active');
                
                // Verificar si es administrador
                isAdmin = user.email === 'thecam35@gmail.com';
                if (isAdmin) {
                    loadVerificationRequests();
                    loadPendingPayments();
                    loadVerifiedSellers();
                    loadTransactionHistory();
                    loadSellersForChat(); // Cargar vendedores para el chat
                    showAdminNotification("Bienvenido al panel de administración", "success");
                }
                
                // Cargar datos adicionales del usuario
                loadUserData(user.uid);
                loadProducts();
                loadCategories();
                loadUserPurchases();
                
                // Escuchar notificaciones
                listenForNotifications();
                
                // Mostrar sección de productos por defecto
                showSection('productsSection');
            } else {
                // Usuario ha cerrado sesión
                authSection.classList.add('active');
                userInfo.classList.remove('active');
                mobileVerificationContainer.style.display = 'none';
                showPublishFormBtn.style.display = 'none';
                publishForm.style.display = 'none';
                sellerVerificationSection.style.display = 'none';
                productsList.innerHTML = '';
                currentUserData = null;
                isAdmin = false;
                cart = [];
                
                // CORRECCIÓN: Resetear variable de productos cargados
                productsLoaded = false;
                
                // Actualizar visibilidad del menú
                updateMenuVisibility();
            }
        });
        
        // Inicializar la aplicación
        function initApp() {
            checkDatabaseConnection();
            updateMenuVisibility();
            
            // Inicialmente mostrar solo la sección de productos o autenticación
            if (auth.currentUser) {
                showSection('productsSection');
                loadProducts();
                loadCategories();
                productsLoaded = true;
            } else {
                showSection('authSection');
            }
        }
        
        // Iniciar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
